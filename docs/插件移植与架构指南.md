# 插件架构与移植指南

本文档旨在为开发者提供关于本插件当前架构的清晰说明，并指导未来如何将插件的核心功能移植到其他平台（如 VS Code, Obsidian 等）。

## 1. 当前架构模式：“智能入口 + 纯UI组件”

为了在“开发效率”与“代码复用性”之间取得平衡，本插件目前采用了一种务实且高效的架构模式：“智能入口 + 纯UI组件”。

-   **智能入口 (`main.ts`)**: 作为插件的“大脑”和“协调者”。它负责处理所有与特定平台（Typora）框架相关的“脏活累活”，包括：
    -   初始化插件、注册命令和设置。
    -   使用 `@typora-community-plugin/core` API 加载和监听配置变化。
    -   创建和管理所有UI组件的生命周期。
    -   将从平台获取的数据（如配置信息）处理成纯粹的数据对象。

-   **纯UI组件 (`src/components/`)**: 作为插件的“视图”。这些是完全独立的、平台无关的UI单元。它们遵循以下原则：
    -   **框架无关**：它们不依赖于任何Typora的插件API。
    -   **数据驱动**：它们只接收来自父级（`main.ts`）传递的普通JavaScript对象（“Props”），并根据这些数据渲染UI。
    -   **高可复用性**：由于其独立性，这些组件理论上可以被直接复用到任何可以使用Web技术的项目中（如网页、其他插件等）。

这种模式的**核心优势**是，我们用较小的重构成本，实现了核心UI逻辑的高度复用，同时保持了项目整体结构的简洁和易于理解。

## 2. 如何移植到新平台

基于当前架构，将核心功能移植到新平台（例如 VS Code）的步骤如下：

#### 第 1 步: 创建新平台的入口文件

在新项目的 `src` 目录下，创建一个符合新平台规范的入口文件，例如 `extension.ts` (for VS Code)。

#### 第 2 步: 重写“智能入口”的逻辑

这是移植的主要工作。你需要在这个新的入口文件中，使用目标平台的API来重新实现 `main.ts` 的核心协调功能：

-   **配置管理**：使用新平台的API来读取和监听配置。
-   **UI渲染**：使用新平台的UI能力（如VS Code的Webview）来提供一个可以承载HTML组件的“面板”或“视图”。
-   **数据传递**：将从平台获取的配置数据，组装成UI组件所期望的普通JavaScript对象。

#### 第 3 步: 直接复用“纯UI组件”

这是当前架构带来的最大便利。你可以几乎原封不动地将 `src/components/` 目录下的所有UI组件代码复制到新项目中。然后，在你的新“智能入口”中，像在 `main.ts` 中一样实例化它们，并将准备好的数据对象传递给它们。

通过这种方式，最复杂的UI和核心交互逻辑得以完整保留和复用。

## 3. 理想的未来架构展望：“核心引擎 + 平台适配器”

> 本章节内容为一种更彻底、更“教科书式”的架构构想，保留于此作为未来插件规模极度复杂化时的参考。

当插件的业务逻辑变得异常复杂，或者需要频繁地在多个平台之间移植时，可以考虑采用更严格的“核心引擎 + 平台适配器”模式。

-   **核心引擎 (`MindmapManager`)**: 一个纯粹的、独立的业务逻辑单元。它负责所有与 Markmap 相关的操作，但完全不知道自己运行在哪个平台。
-   **平台接口 (`IPlatform`)**: 一份“契约”，定义了核心引擎需要从外部平台获得的所有能力（如“获取文本”、“创建UI面板”等）。
-   **平台适配器 (`TyporaAdapter`)**: “契约”的具体实现者，使用特定平台的API来满足 `IPlatform` 接口的要求。

三者关系如下:
```
 [核心引擎] <-- 只依赖 --> [平台接口] <-- 由...实现 -- [平台适配器]
```
这种架构的好处是，当需要移植时，我们**只需更换“平台适配器”**，而“核心引擎”的代码几乎无需改动。

#### 未来如何实现

1.  **创建 `core/` 目录**：将所有平台无关的业务逻辑（如Markdown转换、节点计算等）移入其中。
2.  **定义 `platform/interface.ts`**：创建 `IPlatform` 接口，明确定义引擎需要的所有外部能力。
3.  **创建 `platform/typora/adapter.ts`**：编写 `TyporaAdapter` 类来实现 `IPlatform` 接口。
4.  **改造 `main.ts`**：`main.ts` 的职责将变得更纯粹，只负责创建 `TyporaAdapter` 和 `MindmapManager`，并将二者“粘合”在一起。

再次强调，这是一种理想化的架构，对于当前插件的规模而言，我们目前采用的“智能入口 + 纯UI组件”模式是更具性价比的选择。