---
此文档在项目开发中是有最高优先级的文档，是使用AI辅助开发要首先查看并遵循的文档，此文档负责记录大概的产品需求，具体的功能需求，开发时遇到的具体功能需求；开发可能用到的技术选型；
开发过程中遇到的每一个bug记录，以及解决bug用到的方法，错误的，正确的解决方法。以及过程中的知识经验总结
⚠️此文件只记录以上所说内容的关键（最精简，精炼的）信息，对于每一部分的具体详细说明在更具体的独立文档中，统一放在docs文件夹下，项目根目录下只有此文档和README.md文档

❗️此文档具有最高优先级，每次改动后都要提交git，如果项目有多个分支，也要保证每个分支的该文档保持最新一致的状态
 for AI assistent：
  若要写此文档，应该按照此文档架构来填充内容，不能破坏模板结构。一般不写此文档，或只写总结性内容，大部分由程序员自己总结
  每次回答问题前都看一下此文档的可能的变更内容， 重点观察  ##项目进度 章节下的变更

---





# Typora在typora-community-plugin插件系统下markmap插件开发文档



## Prompt for AI assistent（AI辅助开发提示词）



### 项目目标描述

我现在准备将typora_plugin插件系统中的markmap插件迁移到typora-community-plugin中，要求实现其全部的功能。



我使用此插件的目的时间，让它成为一个能够快速定位的大纲



### 开发环境描述

本次是在macos系统上开发。



**mac中 Typora ，不是一个基于 Chromium 内核的 Electron 应用，而是使用了苹果 macOS 系统原生的 WKWebView 作为渲染引擎。**

所以，在mac中开发和调试Typora有以下困难：

1. 没有内置开发工具：WKWebView 不自带 Chrome DevTools，必须从外部的 Safari 连接进行调试。
2. console.log 可能被抑制：在 WKWebView 的特定实现中，来自 file:// 协议脚本的 console.log 输出可能会因为安全策略或日志系统的不同而被丢弃或重定向，导致我们在 Safari 的控制台看不到它。
3. debugger; 不暂停：这是一个经典的竞争条件 (Race Condition) 问题。插件的 main.js 文件是在 Typora 启动的瞬间被加载和执行的。而您打开 Safari 并连接到 Typora 的调试器需要几秒钟的时间。当您的调试器“连接”上的那一刻，我们的 debugger; 语句早就已经执行完毕了。您看到的只是一个已经被加载、但早已执行结束的脚本。



typora_plugin插件系统中的markmap插件在typora_plugin/plugin/markmap/index.js中，你可以查看它了解要实现的功能。

typora-community-plugin是新插件系统的源代码，迁移时如果要转换相应api，你可以进行查看。







### 项目进度描述

现在项目在typora-plugin-markmap下，所有核心代码是在 main.ts中，其他代码都是插件系统的骨架；打包命令我自己有一定的优化在quick-deploy.sh中，是为了每次更新代码后自动打包并导入到typora中运行。





### 功能需求描述

#### P0功能需求：

1.创建可拖动、可缩放的悬浮窗口，添加核心工具栏按钮(关闭、适应视图、缩放/平移)

2.实现由文章标题结构到`Markmap` 的实时渲染

3.点击结点并定位到文章对应章节，实现类似于大纲的作用

4.实现窗口的吸附与固定功能。

5.进一步的，区别于“右侧固定”：我希望它能成为一个右侧的“菜单栏”，如同typora左侧原生的竖的菜单栏一样，不影响内容区域当点击取消吸附到右侧，它又变回悬浮的可随意调整大小的状态，这算是我对原插件的功能补充

6.像原来的插件一样可以用滚轮调节缩放，并利用插件系统的配置系统能让用户配置诸如画布大小，滚轮缩放，依据窗口大小调节画布大小，鼠标穿透等功能











## 项目架构



### 技术选型





### 核心设计（重点）





### 项目目录结构





## 项目进度

### bug记录

#### 使用markmap库在新插件系统下渲染不成功





### bug解决方案记录

#### 使用markmap库在新插件系统下渲染不成功

要点：

 正确的依赖管理

| 要点 | 说明 | 具体实现 |
|------|------|----------|
| 使用官方markmap包 | 直接使用npm上的markmap相关包，而不是自定义资源文件 | `markmap-lib`、`markmap-view`、`markmap-common`等 |
| 正确的导入方式 | 使用ES6模块导入语法 | `import { Transformer, builtInPlugins } from 'markmap-lib'` |
| 依赖版本管理 | 使用兼容的版本组合 | markmap-lib@0.18.12, markmap-view@0.18.12 |



2. API适配转换

| 原插件系统API | 新插件系统API | 转换要点 |
|---------------|---------------|----------|
| `BasePlugin` | `Plugin` | 继承基类变更 |
| `this.utils.diagramParser.register()` | `CodeblockPostProcessor.from()` | 代码块处理器注册方式 |
| 自定义资源加载 | 直接使用npm包 | 简化资源管理 |
| 手动DOM操作 | 使用插件框架API | 更规范的界面管理 |



3.没有正确使用markmap依赖的函数和api



