# å›ºå®šåˆ°å³ä¾§åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## å®ç°æ­¥éª¤

### 1. æ·»åŠ é…ç½®é€‰é¡¹

åœ¨ `TocMindmapOptions` æ¥å£ä¸­æ·»åŠ ï¼š

```typescript
/** å›ºå®šåˆ°å³ä¾§æ—¶ï¼Œå¯¼å›¾çª—å£å å†…å®¹åŒºåŸŸå®½åº¦çš„ç™¾åˆ†æ¯” */
widthPercentWhenPinRight: number
```

åœ¨ `DEFAULT_TOC_OPTIONS` ä¸­æ·»åŠ é»˜è®¤å€¼ï¼š

```typescript
widthPercentWhenPinRight: 30,
```

### 2. æ‰©å±•ç»„ä»¶çŠ¶æ€

åœ¨ `state` å¯¹è±¡ä¸­æ·»åŠ å›ºå®šçŠ¶æ€ç®¡ç†ï¼š

```typescript
private state = {
  // ... ç°æœ‰å±æ€§
  /** æ˜¯å¦å›ºå®šåˆ°å³ä¾§ */
  isPinRight: false,
  /** å¯¼å›¾çª—å£åŸå§‹ä½ç½®å°ºå¯¸ */
  originModalRect: null as DOMRect | null,
  /** å†…å®¹åŒºåŸŸåŸå§‹ä½ç½®å°ºå¯¸ */
  originContentRect: null as DOMRect | null,
}
```

### 3. ä¿®æ”¹ HTML æ¨¡æ¿

åœ¨ `COMPONENT_TEMPLATE` ä¸­æ·»åŠ å›ºå®šæŒ‰é’®ï¼ˆä¸éœ€è¦é¢å¤–çš„è°ƒæ•´æ‰‹æŸ„å…ƒç´ ï¼‰ï¼š

```typescript
const COMPONENT_TEMPLATE = `
  <div class="markmap-toc-header">
    <span class="markmap-toc-title"></span>
    <div class="markmap-toc-buttons">
      <button class="markmap-toc-btn" data-action="pin-right" title="å›ºå®šåˆ°å³ä¾§">ğŸ“</button>
      <button class="markmap-toc-btn" data-action="dock-left" title="åµŒå…¥ä¾§è¾¹æ ">ğŸ“Œ</button>
      <button class="markmap-toc-btn" data-action="zoom-in" title="æ”¾å¤§">ğŸ”+</button>
      <button class="markmap-toc-btn" data-action="zoom-out" title="ç¼©å°">ğŸ”-</button>
      <button class="markmap-toc-btn" data-action="fit" title="é€‚åº”è§†å›¾">ğŸ¯</button>
      <button class="markmap-toc-btn" data-action="export" title="å¯¼å‡º">ğŸ’¾</button>
      <button class="markmap-toc-btn" data-action="close" title="å…³é—­">Ã—</button>
    </div>
  </div>
  <div class="markmap-toc-content">
    <svg class="markmap-svg"></svg>
  </div>
`;
```

### 4. æ·»åŠ æ ·å¼

åœ¨ `COMPONENT_STYLE` ä¸­æ·»åŠ ï¼š

```css
/* å›ºå®šçŠ¶æ€æ ·å¼ */
.markmap-toc-modal.pinned-right {
  box-shadow: none;
  border-radius: 0;
  border-right: none;
}
```

### 5. å®ç°å›ºå®šé€»è¾‘ï¼ˆä½¿ç”¨ InteractJSï¼‰

æ·»åŠ  `_pinRight` æ–¹æ³•ï¼š

```typescript
private _pinRight() {
  const content = document.querySelector('#write') as HTMLElement;
  if (!content || !this.state.element) return;

  this.state.isPinRight = !this.state.isPinRight;

  if (this.state.isPinRight) {
    // è®°å½•åŸå§‹å°ºå¯¸
    this.state.originModalRect = this.state.element.getBoundingClientRect();
    this.state.originContentRect = content.getBoundingClientRect();

    const { top, height, width, right } = this.state.originContentRect;
    const newWidth = width * this.options.widthPercentWhenPinRight / 100;

    // è®¾ç½®å¯¼å›¾ä½ç½®
    Object.assign(this.state.element.style, {
      top: `${top}px`,
      left: `${right - newWidth}px`,
      width: `${newWidth}px`,
      height: `${height}px`,
      transform: 'none'
    });

    // è°ƒæ•´å†…å®¹åŒºåŸŸ
    content.style.right = `${newWidth}px`;
    content.style.width = `${width - newWidth}px`;

    this.state.element.classList.add('pinned-right');
    
    // é‡æ–°é…ç½® InteractJSï¼šç¦ç”¨æ‹–åŠ¨ï¼Œåªå…è®¸å·¦è¾¹ç¼˜è°ƒæ•´
    interact(this.state.element)
      .draggable(false)
      .resizable({
        edges: { left: true, right: false, top: false, bottom: false },
        listeners: {
          move: (event) => {
            const target = event.target;
            const newWidth = event.rect.width;
            
            // åŒæ­¥è°ƒæ•´ #write çš„å®½åº¦
            const contentWidth = this.state.originContentRect!.width - newWidth;
            content.style.width = `${contentWidth}px`;
            content.style.right = `${newWidth}px`;
            
            // æ›´æ–°å¯¼å›¾ä½ç½®
            target.style.width = `${newWidth}px`;
            target.style.left = `${event.rect.left}px`;
            target.style.transform = 'none';
          }
        }
      });
  } else {
    // æ¢å¤åŸå§‹çŠ¶æ€
    if (this.state.originModalRect) {
      const { left, top, width, height } = this.state.originModalRect;
      Object.assign(this.state.element.style, {
        left: `${left}px`,
        top: `${top}px`,
        width: `${width}px`,
        height: `${height}px`
      });
    }

    content.style.right = '';
    content.style.width = '';

    this.state.element.classList.remove('pinned-right');
    
    // æ¢å¤ InteractJS åŸå§‹é…ç½®
    this._setupInteractJS();
  }
}
```

### 6. ç»‘å®šäº‹ä»¶

åœ¨ `_attachEventListeners` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```typescript
case 'pin-right':
  this._pinRight();
  break;
```

### 7. å“åº”å¼å¤„ç†ï¼ˆå¯é€‰ï¼‰

ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œåœ¨å›ºå®šçŠ¶æ€ä¸‹é‡æ–°è®¡ç®—å¸ƒå±€ï¼š

```typescript
private _handleResize = debounce(() => {
  if (this.state.isPinRight && this.state.element) {
    const content = document.querySelector('#write') as HTMLElement;
    if (!content) return;

    const contentRect = content.getBoundingClientRect();
    const modalRect = this.state.element.getBoundingClientRect();

    this.state.element.style.top = `${contentRect.top}px`;
    this.state.element.style.height = `${contentRect.height}px`;
    this.state.element.style.left = `${contentRect.right - modalRect.width}px`;
  }
}, 100);

// åœ¨ show() æ–¹æ³•ä¸­æ·»åŠ ç›‘å¬
window.addEventListener('resize', this._handleResize);

// åœ¨ hide() æ–¹æ³•ä¸­ç§»é™¤ç›‘å¬
window.removeEventListener('resize', this._handleResize);
```

## æ ¸å¿ƒè¦ç‚¹

1. **ç©ºé—´é‡æ–°åˆ†é…**ï¼šé€šè¿‡ä¿®æ”¹ `#write` çš„ `width` å’Œ `right` å±æ€§ä¸ºå¯¼å›¾è…¾å‡ºç©ºé—´
2. **ä½ç½®è®¡ç®—**ï¼šå¯¼å›¾çš„ `left = content.right - å¯¼å›¾å®½åº¦`
3. **çŠ¶æ€ç®¡ç†**ï¼šè®°å½•åŸå§‹å°ºå¯¸ç”¨äºæ¢å¤
4. **å¤ç”¨ InteractJS**ï¼šé‡æ–°é…ç½® InteractJS å®ç°å®½åº¦è°ƒæ•´ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†é¼ æ ‡äº‹ä»¶
5. **åŒæ­¥è°ƒæ•´**ï¼šåœ¨ InteractJS çš„ `move` äº‹ä»¶ä¸­åŒæ­¥è°ƒæ•´ä¸¤ä¸ªå…ƒç´ çš„å®½åº¦

## å…³é”® API

- `getBoundingClientRect()`ï¼šè·å–å…ƒç´ ç²¾ç¡®ä½ç½®å’Œå°ºå¯¸
- `interact().resizable()`ï¼šé…ç½® InteractJS è°ƒæ•´å¤§å°åŠŸèƒ½
- `Object.assign()`ï¼šæ‰¹é‡è®¾ç½®æ ·å¼
- `classList.add/remove()`ï¼šåˆ‡æ¢ CSS ç±»

## å®ç°ä¼˜åŠ¿

- **ä»£ç æœ€ç®€**ï¼šä¸éœ€è¦é¢å¤–çš„ DOM å…ƒç´ å’Œæ‰‹åŠ¨äº‹ä»¶å¤„ç†
- **å¤ç”¨é€»è¾‘**ï¼šåˆ©ç”¨ InteractJS çš„è¾¹ç¼˜æ£€æµ‹ã€äº‹ä»¶å¤„ç†ç­‰åŠŸèƒ½
- **ä¸é®æŒ¡å†…å®¹**ï¼šç”¨æˆ·å¯åŒæ—¶æŸ¥çœ‹æ–‡æ¡£å’Œå¯¼å›¾
- **åŠ¨æ€è°ƒæ•´**ï¼šæ”¯æŒæ‹–åŠ¨å·¦è¾¹ç¼˜è°ƒæ•´å®½åº¦åˆ†é…
- **å“åº”å¼å¸ƒå±€**ï¼šé€‚åº”çª—å£å˜åŒ–
