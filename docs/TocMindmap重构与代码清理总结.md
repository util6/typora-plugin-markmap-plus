### TocMindmap 组件的演进与重构全景回顾

本文档旨在全景式地回顾 `TocMindmap.ts` 组件从早期优化到深层架构重构的完整演进路径，沉淀经验，为项目的未来发展提供核心指导。

---

### 第一阶段：基础代码质量与可维护性优化 (您的早期工作)

在您最初的优化阶段，您已经敏锐地发现了代码中存在的问题，并开展了两次关键的优化工作，为后续的重构打下了坚实的基础。

#### **1. 第一次重构：提取公共逻辑 (2025-10-09)**

- **核心目标**: 解决代码冗余，提高复用性。
- **关键动作**:
    - 您将重复的 DOM 查询、编号计算、节点遍历和滚动逻辑，分别提取成了 `_getAllHeadingElements()`、`_calculateNumbering()` 等多个独立的私有方法。
- **阶段性成果**:
    - 代码行数减少，模块化程度提高。
    - **关键印证**: 这次重构明确了当时的核心标识符是**层级编号 (numbering)**，并为其创建了专门的辅助函数。这套逻辑虽然清晰，但也暴露了其内在的脆弱性。

#### **2. 第二次优化：提升代码品质 (2025-10-10)**

- **核心目标**: 提升代码的可读性和规范性。
- **关键动作**:
    - 删除了未使用的废弃代码。
    - 将“魔法数字”（如各种延迟时间）提取为具名常量（`DELAYS`）。
    - 定义了 `HeadingInfo` 类型别名，统一了数据结构。
- **阶段性成果**:
    - 代码变得非常整洁、易读，为我们后续的“大手术”提供了清晰的视野。
    - **关键印证**: 此时的 `HeadingInfo` 类型中依然包含 `numbering: string` 字段，进一步说明了当时的设计思想。

**小结**: 在这一阶段，您通过出色的工程实践，将一个混乱的脚本改造成了结构更清晰、代码更规范的模块。但核心的**架构问题**——即依赖脆弱的“编号”作为唯一标识——仍然存在。

---

### 第二阶段：核心架构的颠覆性重构 (我们协作完成)

尽管代码质量得到了提升，但您依然察觉到底层逻辑的混乱并未根除。这促使我们开启了对组件核心架构的颠覆性重构。

#### **1. 核心思路的转变：从“编号”到“路径”**

- **问题的根源**: 我们共同意识到，无论是“编号”还是简单的“标题文本”，都无法作为稳定且唯一的标识符。一次文档编辑就可能导致大量状态失效。
- **革命性的方案**: 最终，我们确立了使用**“从根节点到当前节点的层级文本路径”**作为唯一标识符。这个方案兼具唯一性、稳定性和可读性，是整个重构的基石。

#### **2. 具体的架构重构步骤**

基于“层级文本路径”这个新基石，我们展开了以下一系列重构：

1.  **建立单一数据源**: 引入 `headingsMap`，彻底解决了数据分散和查询效率低下的问题。
2.  **解耦数据与视图**: 放弃了手动操作 `data-` 属性的脆弱做法，改为直接从 D3 绑定的 `__data__` 对象中读取数据，这是本次重构中**最关键、最有效**的一步，极大地简化了代码。
3.  **拆分复杂函数**: 将臃肿的 `_fitToView` 拆分为职责单一的多个小函数，使逻辑清晰化。
4.  **清理冗余与僵尸代码**:
    - 优化了实时更新流程，消除了 `_handleContentChange` 和 `_update` 之间的重复计算。
    - 彻底删除了早已失效的 `showHeadingNumber` 设置项及其所有相关代码。

---

### 总结：一条清晰的演进之路

`TocMindmap` 组件的演进之路清晰地分为两个阶段：

1.  **优化阶段**: 您通过提取公用方法和提升代码质量，完成了对代码的“美颜”和“瘦身”，使其变得可读、可维护。
2.  **重构阶段**: 我们在此基础上，通过转变核心设计思路（标识符的革命），对代码进行了“脱胎换骨”的架构重塑，从根本上解决了逻辑耦合和状态不稳的问题。

这个过程完美地诠释了软件开发的迭代精神：**从解决表面问题，到洞察根本矛盾，再到重塑系统架构**。
