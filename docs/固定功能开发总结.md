# 固定功能开发总结

## Bug 描述

当点击固定到左侧/右侧按钮时，只显示白色区域，看不到顶部的按钮栏。

## 问题分析

### 根本原因

固定功能使用了 `content.getBoundingClientRect().top` 来设置组件的 `top` 位置。当页面滚动时，`getBoundingClientRect()` 返回的是元素相对于**视口**的位置，而不是相对于文档的位置。

**问题场景：**
- 用户向下滚动页面
- `#write` 元素的顶部移出视口上方
- `getBoundingClientRect().top` 返回负值（例如 `-285336`）
- 组件的 `top` 被设置为负值
- 组件的 header 在视口上方，用户看不到

### 实际日志示例

```
固定到右侧: contentTop=-285336, left=48, right=967, width=919, viewportHeight=809, newWidth=275.7, finalLeft=691.3
```

可以看到 `contentTop=-285336`，这是一个极端的负值。

## 解决方案

### 核心思路

固定模式下，组件应该始终占据整个视口，从视口顶部开始，而不是跟随 `#write` 元素的位置。

### 代码修改

修改了两处代码：

#### 1. `_pin()` 方法（初始固定时）

**修改前：**
```typescript
const { top, width, left, right } = content.getBoundingClientRect();
const modalHeight = viewportHeight - top;

Object.assign(this.state.element.style, {
  top: `${top}px`,  // ❌ 使用 content 的 top
  height: `${modalHeight}px`,
  // ...
});
```

**修改后：**
```typescript
const { width, left, right } = content.getBoundingClientRect();
const modalHeight = viewportHeight;  // ✅ 使用整个视口高度

Object.assign(this.state.element.style, {
  top: '0px',  // ✅ 始终从视口顶部开始
  height: `${modalHeight}px`,
  // ...
});
```

#### 2. `_handleResize()` 方法（窗口大小改变时）

同样的修改逻辑：
- 将 `top` 从 `${contentRect.top}px` 改为 `'0px'`
- 将 `modalHeight` 从 `viewportHeight - contentRect.top` 改为 `viewportHeight`

### 调试日志

为了便于问题定位，添加了调试日志：

```typescript
logger(`固定到${side === 'left' ? '左' : '右'}侧: contentTop=${contentTop}, left=${left}, right=${right}, width=${width}, viewportHeight=${viewportHeight}, newWidth=${newWidth}, finalLeft=${isLeft ? left : right - newWidth}`);

// 验证实际位置
const actualRect = this.state.element.getBoundingClientRect();
logger(`固定后实际位置: top=${actualRect.top}, left=${actualRect.left}, width=${actualRect.width}, height=${actualRect.height}`);
```

## 关键知识点

### getBoundingClientRect() 的行为

- 返回元素相对于**视口**的位置，不是相对于文档
- 当元素在视口上方时，`top` 为负值
- 当元素在视口下方时，`top` 大于视口高度
- 滚动会改变返回值

### 固定定位的正确使用

对于 `position: fixed` 的元素：
- 如果要占据整个视口，应该使用 `top: 0` 和 `height: 100vh` 或 `window.innerHeight`
- 不应该使用其他元素的 `getBoundingClientRect()` 结果来设置 `top`
- `left` 可以使用其他元素的位置，因为我们需要对齐到 `#write` 的左/右边缘

## 后续优化建议

1. 考虑 Typora 顶部工具栏的高度，可能需要预留空间
2. 在生产环境中移除或条件化调试日志
3. 测试不同滚动位置下的固定/取消固定行为
4. 测试窗口大小改变时的响应式行为
