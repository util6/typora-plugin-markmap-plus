# 固定到左/右侧功能开发总结

## 功能概述

实现 Markmap 思维导图窗口固定到 Typora 编辑器左侧或右侧的功能，固定后窗口与编辑区域并排显示，可通过拖动边界调整两者宽度比例。

## 开发思路

### 1. 核心实现逻辑

**状态管理**：
- `isPinLeft` / `isPinRight`：记录当前固定状态
- `originModalRect` / `originContentRect`：保存固定前的原始位置和尺寸，用于恢复

**布局调整**：
- 固定时：调整 Markmap 窗口位置和尺寸，同时设置 `#write` 的 `marginLeft` 或 `marginRight`
- 取消固定时：恢复原始位置，清除 margin

**交互控制**：
- 固定状态下禁用拖动，启用边缘 resize
- 固定左侧时只能拖动右边缘，固定右侧时只能拖动左边缘

### 2. UI 设计

**按钮图标**：
- 初始状态：左侧 `◀️`，右侧 `▶️`
- 固定后：`⏸️`（暂停图标表示已固定）
- 提示文本随状态动态更新

### 3. 响应式处理

监听窗口 resize 事件，在 Typora 窗口大小变化时重新计算固定布局。

## 遇到的问题与解决方案

### 问题 1：侧边栏嵌入功能冗余

**问题描述**：
原有的"嵌入侧边栏"功能与固定功能概念重叠，且实现复杂。

**解决方案**：
完全删除嵌入侧边栏相关代码：
- 删除 `_toggleEmbed()` 方法
- 删除 `isEmbedded` 和 `resizeObserver` 状态
- 删除 `allowDragWhenEmbedded` 配置项
- 删除嵌入按钮和相关 CSS 样式
- 简化 `_updateInteractSettings()` 逻辑

### 问题 2：margin 方向与固定方向不匹配

**问题描述**：
窗口固定到右侧，但代码设置的是 `marginLeft`，导致内容区域在左侧被压缩，而右侧的 Markmap 窗口与内容区域重叠。

**原因分析**：
没有根据固定方向动态选择正确的 margin 属性。

**解决方案**：
使用变量动态确定 margin 方向：
```typescript
const isLeft = side === 'left';
const marginKey = isLeft ? 'marginLeft' : 'marginRight';

// 固定时设置对应方向的 margin
content.style[marginKey] = `${newWidth}px`;

// 取消固定时清除对应方向的 margin
content.style[marginKey] = '';
```

### 问题 3：左右按钮图标相同且不随状态变化

**问题描述**：
初始实现中左右固定按钮都使用 📍 图标，无法区分，且固定后图标不变。

**解决方案**：
```typescript
// 初始 HTML 使用不同图标
<button data-action="pin-left">◀️</button>
<button data-action="pin-right">▶️</button>

// 在 _pin() 方法中动态更新
if (this.state[stateKey]) {
  btn.innerHTML = '⏸️';
  btn.title = isLeft ? '取消固定左侧' : '取消固定右侧';
} else {
  btn.innerHTML = isLeft ? '◀️' : '▶️';
  btn.title = isLeft ? '固定到左侧' : '固定到右侧';
}
```

### 问题 4：切换固定方向时状态混乱

**问题描述**：
从固定右侧切换到固定左侧时，没有清理右侧的固定状态（margin、CSS 类、按钮状态等）。

**解决方案**：
在固定前先检查并清理另一侧的状态：
```typescript
// 如果另一侧已固定，先清理
if (this.state[otherStateKey]) {
  this.state[otherStateKey] = false;
  content.style[otherMarginKey] = '';
  this.state.element.classList.remove(otherCssClass);
  
  // 更新另一侧按钮状态
  const otherBtn = this.state.element.querySelector(`[data-action="pin-${isLeft ? 'right' : 'left'}"]`);
  if (otherBtn) {
    otherBtn.innerHTML = isLeft ? '▶️' : '◀️';
    otherBtn.title = isLeft ? '固定到右侧' : '固定到左侧';
  }
}
```

### 问题 5：切换方向后恢复位置错误

**问题描述**：
固定右侧 → 固定左侧 → 恢复自由状态，窗口位置不是最初的位置。

**原因分析**：
每次固定都会覆盖 `originModalRect`，导致保存的是中间状态而非初始状态。

**解决方案**：
只在首次固定时保存原始位置，完全恢复自由状态时才清空：
```typescript
// 固定时：只在首次保存
if (!this.state.originModalRect) {
  this.state.originModalRect = this.state.element.getBoundingClientRect();
  this.state.originContentRect = content.getBoundingClientRect();
}

// 取消固定时：检查是否完全恢复
if (!this.state.isPinLeft && !this.state.isPinRight) {
  this.state.originModalRect = null;
  this.state.originContentRect = null;
}
```

### 问题 6：边缘拖动方向错误

**问题描述**：
固定左侧时应该只能拖动右边缘，但配置错误导致拖动方向不对。

**解决方案**：
修正 InteractJS 的 edges 配置：
```typescript
// 固定左侧：只能拖动右边缘
// 固定右侧：只能拖动左边缘
.resizable({
  edges: { left: !isLeft, right: isLeft, top: false, bottom: false }
})
```

### 问题 7：窗口大小变化时布局异常

**问题描述**：
Typora 窗口大小变化时，固定状态的 Markmap 窗口位置和宽度不正确。

**原因分析**：
1. `_handleResize()` 获取 `contentRect` 时，`#write` 的 margin 还在，导致位置计算错误
2. 没有重新计算 Markmap 窗口宽度
3. 没有重新设置 margin

**解决方案**：
```typescript
private _handleResize = debounce(() => {
  // 临时清除 margin 以获取真实位置
  const oldMarginLeft = content.style.marginLeft;
  const oldMarginRight = content.style.marginRight;
  content.style.marginLeft = '';
  content.style.marginRight = '';

  const contentRect = content.getBoundingClientRect();
  const newWidth = contentRect.width * this.options.widthPercentWhenPinRight / 100;

  if (this.state.isPinRight) {
    this.state.element.style.width = `${newWidth}px`;
    this.state.element.style.left = `${contentRect.right - newWidth}px`;
    content.style.marginRight = `${newWidth}px`;
  } else if (this.state.isPinLeft) {
    this.state.element.style.width = `${newWidth}px`;
    this.state.element.style.left = `${contentRect.left}px`;
    content.style.marginLeft = `${newWidth}px`;
  }
}, 100);
```

## 关键技术点

### 1. 状态同步
- Markmap 窗口的位置、尺寸
- `#write` 的 margin
- CSS 类（`pinned-left` / `pinned-right`）
- 按钮图标和提示文本

### 2. InteractJS 配置
- 固定时禁用 draggable
- 根据固定方向配置 resizable 的 edges
- resize 时同步更新 margin

### 3. 响应式处理
- 使用 debounce 优化性能
- 临时清除 margin 获取真实位置
- 按比例重新计算宽度

## 最终效果

✅ 左右固定按钮图标不同且随状态变化  
✅ 固定时可拖动边界调整宽度比例  
✅ 切换固定方向时正确清理状态  
✅ 恢复自由状态时回到初始位置  
✅ 窗口大小变化时布局自适应  
✅ 代码简洁，逻辑清晰
