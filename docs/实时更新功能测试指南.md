# 实时更新功能测试指南

## 修复内容总结

### 主要问题和修复

1. **MutationObserver 过滤过于严格** ✅ 已修复
   - 原问题：只监听标题元素的直接变化，遗漏了文本节点变化
   - 修复方案：恢复更宽松的监听机制，监听所有可能影响标题的变化

2. **防抖时间过于激进** ✅ 已修复
   - 原问题：100ms 可能导致过于频繁的更新
   - 修复方案：调整为 200ms，平衡响应速度和性能

3. **缺少调试信息** ✅ 已修复
   - 原问题：无法确定事件是否被正确触发
   - 修复方案：添加详细的调试日志和错误处理

4. **事件系统检测不完整** ✅ 已修复
   - 原问题：只检查有限的事件系统路径
   - 修复方案：扩展检测范围，支持多种可能的事件系统位置

## 测试步骤

### 1. 基础功能测试

1. **启动插件**
   ```bash
   cd "/Users/util6/code-space/typora插件开发/typora-plugin-markmap-plus"
   npm run build
   ```

2. **在 Typora 中加载插件**
   - 重启 Typora
   - 打开一个包含标题的 Markdown 文档
   - 点击悬浮按钮打开思维导图

3. **检查初始化日志**
   - 打开浏览器开发者工具 (F12)
   - 查看控制台输出，应该看到类似信息：
   ```
   ✅ 使用 MutationObserver 进行实时更新
   MutationObserver 已启动，监听范围：childList, subtree, characterData, attributes
   ```

### 2. 实时更新测试

#### 方法一：手动测试
1. **添加新标题**
   - 在文档中输入新的标题（如 `# 新标题`）
   - 观察思维导图是否在 200ms 后自动更新

2. **修改现有标题**
   - 修改已有标题的文本内容
   - 观察思维导图是否反映变化

3. **删除标题**
   - 删除一个标题
   - 观察思维导图是否移除对应节点

#### 方法二：使用测试脚本
1. **加载测试脚本**
   - 在浏览器控制台中粘贴 `test-realtime-update.js` 的内容
   - 或者直接运行：
   ```javascript
   // 复制 test-realtime-update.js 内容到控制台
   ```

2. **运行测试**
   ```javascript
   // 运行所有测试
   testRealTimeUpdate.runAll()
   
   // 或单独测试
   testRealTimeUpdate.checkEventSystem()  // 检查事件系统
   testRealTimeUpdate.addHeading()        // 测试添加标题
   testRealTimeUpdate.modifyHeading()     // 测试修改标题
   ```

### 3. 调试信息检查

在控制台中查找以下关键日志：

#### 正常工作的日志
```
🔍 开始检查内容变化...
当前标题数量: 5, 哈希: 1:标题1|2:标题2|3:标题3...
✅ 检测到标题结构变化，开始更新思维导图
✅ 思维导图更新完成
```

#### 跳过更新的日志
```
⏭️ 标题结构未变化，跳过更新
```

#### 错误日志
```
❌ 处理内容变化时出错: [错误信息]
```

### 4. 性能测试

1. **大文档测试**
   - 创建包含 50+ 标题的大文档
   - 测试实时更新的响应速度和流畅度

2. **频繁编辑测试**
   - 快速连续修改多个标题
   - 观察防抖机制是否正常工作（应该合并更新请求）

3. **状态保持测试**
   - 手动折叠一些思维导图节点
   - 修改文档内容触发更新
   - 检查折叠状态是否保持

## 预期结果

### ✅ 成功指标
- 修改标题后 200ms 内思维导图自动更新
- 控制台显示详细的调试信息
- 节点折叠状态在更新后保持
- 大文档下性能流畅
- 频繁编辑时防抖机制正常工作

### ❌ 失败指标
- 修改标题后思维导图不更新
- 控制台出现错误信息
- 更新后节点折叠状态丢失
- 性能明显下降或卡顿

## 故障排除

### 如果实时更新仍然不工作

1. **检查设置**
   ```javascript
   // 在控制台检查设置
   console.log('实时更新设置:', plugin.settings.enableRealTimeUpdate)
   ```

2. **手动触发更新**
   ```javascript
   // 手动触发一次更新测试
   plugin.tocComponent._handleContentChange()
   ```

3. **检查 MutationObserver**
   ```javascript
   // 检查观察器状态
   console.log('观察器状态:', plugin.tocComponent.state.contentObserver)
   ```

4. **回退到原始实现**
   - 如果问题持续，可以临时禁用优化的实时更新
   - 在设置中关闭 "实时更新" 功能
   - 使用手动刷新按钮

## 后续优化建议

1. **添加用户可配置的防抖时间**
2. **实现更智能的变化检测**
3. **添加性能监控和统计**
4. **支持更多 Typora 事件类型**

---

**注意**：如果测试过程中发现任何问题，请记录详细的错误信息和复现步骤，以便进一步优化。
