# Typora 插件设置面板开发指南

## 概述

本文档介绍如何为 Typora Markmap 插件添加设置面板功能，基于 `@typora-community-plugin/core` 提供的 API。

## 核心 API

### 1. Settings 类

用于管理插件配置数据的持久化存储。

```typescript
import { Settings, SettingsOptions } from '@typora-community-plugin/core'

interface SettingsOptions {
  filename: string;    // 相对于 .typora 配置文件夹的文件名
  version: number;     // 设置文件结构版本
  migations?: SettingMigrations; // 版本迁移配置
}
```

### 2. PluginSettings 类

插件专用的设置管理类，继承自 Settings。

```typescript
import { PluginSettings } from '@typora-community-plugin/core'

class PluginSettings<T extends Record<string, any>> extends Settings<T> {
  constructor(app: App, manifest: PluginManifest, options: PluginSettingsOptions)
}
```

### 3. SettingTab 类

设置面板的基础类。

```typescript
import { SettingTab, SettingItem } from '@typora-community-plugin/core'

abstract class SettingTab extends View {
  abstract get name(): string;
  
  addSettingTitle(text: string): void;
  addSetting(build: (setting: SettingItem) => void): void;
  onshow(): void;
  onhide(): void;
}
```

### 4. SettingItem 类

单个设置项的构建器。

```typescript
class SettingItem extends View {
  addName(name: string): void;
  addDescription(description: string): void;
  addCheckbox(build: (checkbox: HTMLInputElement) => void): void;
  addButton(build: (button: HTMLButtonElement) => void): void;
  addText(build: (input: HTMLInputElement) => void): void;
  addTextArea(build: (input: HTMLTextAreaElement) => void): void;
  addSelect(build: (input: HTMLSelectElement) => void): void;
  addTag(text: string, build?: (el: HTMLElement) => void): void;
}
```

## 实现步骤

### 1. 定义设置接口

```typescript
// src/settings.ts
export interface MarkmapSettings {
  // 默认配置
  defaultHeight: string;
  defaultBackgroundColor: string;
  defaultSpacingHorizontal: number;
  defaultSpacingVertical: number;
  
  // TOC 配置
  tocAutoUpdate: boolean;
  tocInitialExpandLevel: number;
  tocShowFloatingButton: boolean;
  
  // 快捷键配置
  toggleTocHotkey: string;
  
  // 主题配置
  colorScheme: 'default' | 'dark' | 'light';
  customColors: string[];
}

export const DEFAULT_SETTINGS: MarkmapSettings = {
  defaultHeight: '300px',
  defaultBackgroundColor: '#f8f8f8',
  defaultSpacingHorizontal: 80,
  defaultSpacingVertical: 20,
  tocAutoUpdate: true,
  tocInitialExpandLevel: 3,
  tocShowFloatingButton: true,
  toggleTocHotkey: 'cmd+m',
  colorScheme: 'default',
  customColors: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#00BCD4']
}
```

### 2. 创建设置面板

```typescript
// src/setting-tab.ts
import { SettingTab, SettingItem, PluginSettings } from '@typora-community-plugin/core'
import { MarkmapSettings, DEFAULT_SETTINGS } from './settings'

export class MarkmapSettingTab extends SettingTab {
  private settings: PluginSettings<MarkmapSettings>

  constructor(settings: PluginSettings<MarkmapSettings>) {
    super()
    this.settings = settings
  }

  get name(): string {
    return 'Markmap'
  }

  onshow(): void {
    this.containerEl.empty()
    
    // 基础设置
    this.addSettingTitle('基础设置')
    
    this.addSetting(item => {
      item.addName('默认高度')
      item.addDescription('代码块思维导图的默认高度')
      item.addText(input => {
        input.value = this.settings.get('defaultHeight')
        input.onchange = () => {
          this.settings.set('defaultHeight', input.value)
        }
      })
    })

    this.addSetting(item => {
      item.addName('默认背景色')
      item.addDescription('思维导图的默认背景颜色')
      item.addText(input => {
        input.type = 'color'
        input.value = this.settings.get('defaultBackgroundColor')
        input.onchange = () => {
          this.settings.set('defaultBackgroundColor', input.value)
        }
      })
    })

    // TOC 设置
    this.addSettingTitle('目录思维导图')
    
    this.addSetting(item => {
      item.addName('自动更新')
      item.addDescription('文档内容变化时自动更新 TOC 思维导图')
      item.addCheckbox(checkbox => {
        checkbox.checked = this.settings.get('tocAutoUpdate')
        checkbox.onchange = () => {
          this.settings.set('tocAutoUpdate', checkbox.checked)
        }
      })
    })

    this.addSetting(item => {
      item.addName('显示悬浮按钮')
      item.addDescription('在右下角显示 TOC 思维导图的悬浮按钮')
      item.addCheckbox(checkbox => {
        checkbox.checked = this.settings.get('tocShowFloatingButton')
        checkbox.onchange = () => {
          this.settings.set('tocShowFloatingButton', checkbox.checked)
        }
      })
    })

    // 主题设置
    this.addSettingTitle('主题设置')
    
    this.addSetting(item => {
      item.addName('配色方案')
      item.addDescription('选择思维导图的配色方案')
      item.addSelect(select => {
        select.innerHTML = `
          <option value="default">默认</option>
          <option value="dark">深色</option>
          <option value="light">浅色</option>
        `
        select.value = this.settings.get('colorScheme')
        select.onchange = () => {
          this.settings.set('colorScheme', select.value as any)
        }
      })
    })
  }
}
```

### 3. 在主插件中注册

```typescript
// src/main.ts
import { Plugin, PluginSettings } from '@typora-community-plugin/core'
import { MarkmapSettingTab } from './setting-tab'
import { MarkmapSettings, DEFAULT_SETTINGS } from './settings'

export default class MarkmapPlugin extends Plugin<MarkmapSettings> {
  private pluginSettings: PluginSettings<MarkmapSettings>
  private settingTab: MarkmapSettingTab

  onload() {
    // 初始化设置
    this.pluginSettings = new PluginSettings(this.app, this.manifest, {
      version: 1
    })
    this.pluginSettings.setDefault(DEFAULT_SETTINGS)
    this.pluginSettings.load()

    // 注册设置
    this.registerSettings(this.pluginSettings)

    // 创建并注册设置面板
    this.settingTab = new MarkmapSettingTab(this.pluginSettings)
    this.registerSettingTab(this.settingTab)

    // 监听设置变化
    this.pluginSettings.onChange('tocShowFloatingButton', (key, value) => {
      if (value) {
        this.showFloatingButton()
      } else {
        this.hideFloatingButton()
      }
    })
  }

  // 获取设置值的便捷方法
  getSetting<K extends keyof MarkmapSettings>(key: K): MarkmapSettings[K] {
    return this.pluginSettings.get(key)
  }

  // 设置值的便捷方法
  setSetting<K extends keyof MarkmapSettings>(key: K, value: MarkmapSettings[K]): void {
    this.pluginSettings.set(key, value)
  }
}
```

### 4. 在代码中使用设置

```typescript
// 在渲染思维导图时使用设置
renderMarkmap(code: string, svg: SVGElement) {
  const options = this.parseFrontMatter(code)
  
  // 使用设置中的默认值
  const finalOptions = {
    height: options.height || this.getSetting('defaultHeight'),
    backgroundColor: options.backgroundColor || this.getSetting('defaultBackgroundColor'),
    spacingHorizontal: options.spacingHorizontal || this.getSetting('defaultSpacingHorizontal'),
    spacingVertical: options.spacingVertical || this.getSetting('defaultSpacingVertical'),
    color: this.getSetting('customColors'),
    ...options
  }

  // 应用设置
  if (finalOptions.height) {
    svg.style.height = finalOptions.height
  }
  if (finalOptions.backgroundColor) {
    svg.style.backgroundColor = finalOptions.backgroundColor
  }
}
```

## 高级功能

### 1. 设置迁移

```typescript
// 处理设置版本升级
const migrations = new SettingMigrations()
migrations.addMigration(1, 2, (oldSettings) => {
  // 从版本 1 升级到版本 2
  return {
    ...oldSettings.settings,
    newField: 'defaultValue'
  }
})

this.pluginSettings = new PluginSettings(this.app, this.manifest, {
  version: 2,
  migations: migrations
})
```

### 2. 复杂设置项

```typescript
// 颜色列表设置
this.addSetting(item => {
  item.addName('自定义颜色')
  item.addDescription('设置思维导图节点的颜色')
  
  const colors = this.settings.get('customColors')
  colors.forEach((color, index) => {
    item.addTag(color, (tag) => {
      tag.style.backgroundColor = color
      tag.onclick = () => {
        // 编辑颜色逻辑
      }
    })
  })
  
  item.addButton(button => {
    button.textContent = '添加颜色'
    button.onclick = () => {
      // 添加新颜色逻辑
    }
  })
})
```

### 3. 实时预览

```typescript
// 添加实时预览功能
this.addSetting(item => {
  item.addName('间距设置')
  item.addDescription('调整思维导图节点间距')
  
  const preview = item.containerEl.createDiv('markmap-preview')
  
  item.addText(input => {
    input.type = 'range'
    input.min = '20'
    input.max = '200'
    input.value = this.settings.get('defaultSpacingHorizontal').toString()
    
    input.oninput = () => {
      // 实时更新预览
      this.updatePreview(preview, parseInt(input.value))
    }
    
    input.onchange = () => {
      this.settings.set('defaultSpacingHorizontal', parseInt(input.value))
    }
  })
})
```

## 最佳实践

1. **设置分组**: 使用 `addSettingTitle()` 将相关设置分组
2. **描述清晰**: 为每个设置项添加清晰的描述
3. **默认值**: 始终提供合理的默认值
4. **实时反馈**: 重要设置变化时提供实时反馈
5. **版本管理**: 使用版本号管理设置结构变化
6. **性能优化**: 避免在设置变化时执行重量级操作

## 调试技巧

```typescript
// 添加调试信息
this.pluginSettings.onChange('*', (key, value) => {
  console.log(`Setting changed: ${key} = ${value}`)
})

// 导出/导入设置
this.addSetting(item => {
  item.addButton(button => {
    button.textContent = '导出设置'
    button.onclick = () => {
      const settings = this.pluginSettings._stores
      navigator.clipboard.writeText(JSON.stringify(settings, null, 2))
    }
  })
})
```

这个开发指南提供了完整的设置面板实现方案，可以根据具体需求进行调整和扩展。

使用嵌入侧边栏后，Markmap画布十分模糊，分析原因

我仍然希望你把整个窗口放在typora-sidebar下，与sidebar-content并列

使用嵌入侧边栏后，Markmap画布十分模糊，完全无法放大。我调试分析了一下可能原因，在正常模式下svg这个画布在使用放大功能时，画布大小会变大，会大过组件窗口；
在嵌入模式中的放大，画布大小其实没有变，只是把图片生硬的放大，所以非常模糊；可能是画布大小被容器限制了；根据我的分析，再分析具体原因

在现在的放大、缩小、适应视图功能中，使用 transform: scale() - 只是视觉放大，不增加分辨率 → 模糊
应该：使用 markmap.rescale() - 真正重新渲染SVG → 清晰

fitToMousePosition() 方法： 不要简化逻辑！！！
