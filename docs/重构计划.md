# TocMindmap ç»„ä»¶é‡æ„è®¡åˆ’

## é‡æ„ç›®æ ‡

æœ¬æ¬¡é‡æ„æ—¨åœ¨å½»åº•è§£å†³å½“å‰ `TocMindmap` ç»„ä»¶åœ¨èŠ‚ç‚¹è·¯å¾„ç®¡ç†ã€çŠ¶æ€åŒæ­¥å’ŒåŠŸèƒ½å®ç°ä¸Šçš„æ··ä¹±çŠ¶å†µã€‚æˆ‘ä»¬å°†åºŸå¼ƒå½“å‰æ‰‹åŠ¨ç»´æŠ¤çš„ã€åŸºäºæ–‡æœ¬çš„è·¯å¾„ç³»ç»Ÿï¼Œå…¨é¢è½¬å‘ä½¿ç”¨ Markmap åº“è‡ªèº«æä¾›çš„ã€æ›´ç¨³å®šã€æ›´å¯é çš„åŸç”Ÿæ•°æ®å±æ€§ã€‚

**æœ€ç»ˆç›®æ ‡ï¼š** æå‡ä»£ç çš„å¯è¯»æ€§ã€ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œä¸ºæœªæ¥æ‰©å±•åŠŸèƒ½æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚

## æ ¸å¿ƒé—®é¢˜

å½“å‰ä»£ç é”™è¯¯åœ°å°†æ–‡æœ¬è·¯å¾„ï¼ˆå¦‚ `"ç¬¬ä¸€ç« \nç¬¬ä¸€èŠ‚"`ï¼‰å­˜å‚¨ä¸ºèŠ‚ç‚¹è·¯å¾„ï¼Œä½† markmap çš„ `state.path` å®é™…æ˜¯ç”±èŠ‚ç‚¹ ID ç»„æˆçš„æ•°å­—è·¯å¾„ï¼ˆå¦‚ `"0.1.3"`ï¼‰ï¼Œç”± markmap-view è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†ã€‚

## é‡æ„åŸåˆ™



æ‰€æœ‰é‡æ„å·¥ä½œå°†ä¸¥æ ¼éµå¾ªä»¥ä¸‹å‡†åˆ™ï¼š

1.  **è·¯å¾„æ ‡è¯†**ï¼š**å”¯ä¸€**ä½¿ç”¨ `INode.state.path` (`"0.1.3"` æ ¼å¼) ä½œä¸ºèŠ‚ç‚¹çš„æŒä¹…åŒ–ã€å”¯ä¸€çš„èº«ä»½æ ‡è¯†ã€‚åºŸå¼ƒä»»ä½•æ‰‹åŠ¨æ‹¼æ¥çš„æ–‡æœ¬è·¯å¾„ã€‚
2.  **æŠ˜å çŠ¶æ€**ï¼šæŠ˜å çŠ¶æ€çš„è¯»å–**å”¯ä¸€**ä¾èµ– `INode.payload.fold` å±æ€§ã€‚
3.  **æŠ˜å æ“ä½œ**ï¼šä»¥ç¼–ç¨‹æ–¹å¼ä¿®æ”¹æŠ˜å çŠ¶æ€ï¼Œ**å”¯ä¸€**ä½¿ç”¨ `markmap.toggleNode()` APIã€‚**ç¦æ­¢**ä»»ä½•â€œæ‰‹åŠ¨ä¿®æ”¹ `payload.fold` åè°ƒç”¨ `renderData/setData`â€çš„å°è¯•ï¼Œå› å…¶å·²è¢«è¯å®ä¸å¯é ã€‚
4.  **æ•°æ®é©±åŠ¨**ï¼šæ‰€æœ‰æ“ä½œåº”ä»¥æ•°æ®ä¸ºä¸­å¿ƒã€‚å…ˆä¿®æ”¹æ•°æ®ï¼ˆæˆ–é€šè¿‡APIé—´æ¥ä¿®æ”¹ï¼‰ï¼Œå†ç”± Markmap åº“è‡ªåŠ¨æ›´æ–°è§†å›¾ã€‚é¿å…ç›´æ¥æ“ä½œ DOMã€‚







---

## API ä¾æ®è¯´æ˜

#### IPureNode (markmap-lib è¾“å‡ºçš„çº¯æ•°æ®èŠ‚ç‚¹)

```typescript
// ç”± transformer.transform() ç”Ÿæˆçš„çº¯æ•°æ®èŠ‚ç‚¹
interface IPureNode {
  content: string;           // èŠ‚ç‚¹çš„ HTML å†…å®¹
  payload?: {
    [key: string]: unknown;
    fold?: number;           // æŠ˜å çŠ¶æ€: 0=å±•å¼€, 1=æŠ˜å , 2=é€’å½’æŠ˜å 
  };
  children: IPureNode[];     // å­èŠ‚ç‚¹æ•°ç»„
}
```

#### INode (markmap-view ä½¿ç”¨çš„å¸¦çŠ¶æ€èŠ‚ç‚¹)

```typescript
// åœ¨ markmap-view å†…éƒ¨ä½¿ç”¨ï¼Œå¢åŠ äº† state å±æ€§
interface INode extends IPureNode {
  state: INodeState;
  children: INode[];
}

interface INodeState {
  id: number;                // è‡ªå¢å”¯ä¸€ID
  path: string;              // ç‚¹åˆ†éš”çš„è·¯å¾„ (å¦‚ "0.1.2")
  key: string;               // åŸºäºå†…å®¹çš„å”¯ä¸€æ ‡è¯†
  depth: number;             // èŠ‚ç‚¹æ·±åº¦
  el: HTMLElement;           // DOM å…ƒç´ å¼•ç”¨
  // ... å…¶ä»–æ¸²æŸ“ç›¸å…³çš„ä¸´æ—¶åæ ‡å’Œå°ºå¯¸ä¿¡æ¯
}
```

### 3. state.path çš„ç”Ÿæˆé€»è¾‘



```javascript
// markmap-view å†…éƒ¨å®ç°
a.state.id = i;  // è‡ªå¢ ID: 0, 1, 2, 3...

// path ç”±çˆ¶èŠ‚ç‚¹ path + å½“å‰èŠ‚ç‚¹ id ç»„æˆ
a.state.path = [
  parentNode?.state?.path,  // çˆ¶èŠ‚ç‚¹çš„ path
  a.state.id                // å½“å‰èŠ‚ç‚¹çš„ id
].filter(Boolean).join(".")
```

**ç¤ºä¾‹**ï¼š
```
æ ¹èŠ‚ç‚¹:           state.id = 0,  state.path = "0"
â”œâ”€ ç¬¬1ä¸ªå­èŠ‚ç‚¹:    state.id = 1,  state.path = "0.1"
â”œâ”€ ç¬¬2ä¸ªå­èŠ‚ç‚¹:    state.id = 2,  state.path = "0.2"
   â””â”€ å­™å­èŠ‚ç‚¹:    state.id = 3,  state.path = "0.2.3"
```

**å…³é”®ç†è§£**ï¼š
- `state.path` æ˜¯æ•°å­—è·¯å¾„ï¼Œä¸æ˜¯æ–‡æœ¬è·¯å¾„
- ç”± markmap-view è‡ªåŠ¨ç”Ÿæˆï¼Œä¸åº”æ‰‹åŠ¨ä¿®æ”¹
- å¯ä½œä¸ºèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦ä½¿ç”¨

### 4. å·¥ä½œæµç¨‹ï¼ˆæ¥è‡ª Markmap_APIæŒ‡å—.mdï¼‰

```typescript
// 1. markmap-lib: Markdown æ–‡æœ¬ â†’ æ ‘å½¢æ•°æ®
const transformer = new Transformer();
const { root } = transformer.transform(markdown);

// 2. markmap-view: æ ‘å½¢æ•°æ® â†’ SVG æ¸²æŸ“
const mm = Markmap.create('#svg', options, root);
```

**å…³é”®ç†è§£**ï¼š
- markmap-lib åªè´Ÿè´£è§£æ Markdown æ ‡é¢˜ï¼Œç”Ÿæˆ `INode` æ ‘
- markmap-view è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’ï¼Œè‡ªåŠ¨æ·»åŠ  `state` å­—æ®µ
- ä¸¤ä¸ªåº“ä¹‹é—´é€šè¿‡ `INode` æ•°æ®ç»“æ„ä¼ é€’ä¿¡æ¯

### 5. é‡æ„æ–¹æ¡ˆçš„ API ä½¿ç”¨

åŸºäºä»¥ä¸Šç†è§£ï¼Œé‡æ„æ–¹æ¡ˆçš„æ ¸å¿ƒæ”¹åŠ¨ï¼š

| æ“ä½œ | é”™è¯¯åšæ³• | æ­£ç¡®åšæ³• | API ä¾æ® |
|------|---------|---------|---------|
| èŠ‚ç‚¹æ ‡è¯† | æ‰‹åŠ¨æ„å»ºæ–‡æœ¬è·¯å¾„ | ä½¿ç”¨ `state.path` | `INode.state.path` ç”± markmap-view ç”Ÿæˆ |
| å­˜å‚¨è‡ªå®šä¹‰æ•°æ® | è¦†ç›– `state.path` | ä½¿ç”¨ `payload` | `INode.payload` æ˜¯ç”¨æˆ·æ‰©å±•å­—æ®µ |
| æŸ¥æ‰¾èŠ‚ç‚¹ | éå†æ–‡æœ¬è·¯å¾„ | é€šè¿‡ `state.path` æŸ¥æ‰¾ | `state.path` æ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ |
| å±•å¼€èŠ‚ç‚¹ | æ‰‹åŠ¨æ“ä½œ DOM | è°ƒç”¨ `markmap.toggleNode()` | markmap-view æä¾›çš„å®ä¾‹æ–¹æ³• |
| æ›´æ–°æ•°æ® | é‡æ–°åˆ›å»ºå®ä¾‹ | è°ƒç”¨ `markmap.setData()` | ä¿æŒæŠ˜å çŠ¶æ€å’Œè§†å›¾ä½ç½® |







## äºŒã€ç±»å‹å®šä¹‰ä¿®æ”¹

### `HeadingInfo` ç±»å‹

**å½“å‰å®šä¹‰**ï¼š
```typescript
type HeadingInfo = {
  level: number;
  text: string;
  id: string;
  index: number;
  path: string;        // â† åˆ é™¤æ­¤å­—æ®µ
  element: HTMLElement;
};
```

**ä¿®æ”¹å**ï¼š
```typescript
type HeadingInfo = {
  level: number;
  text: string;
  id: string;
  index: number;
  element: HTMLElement;
};
```

**åŸå› **ï¼š`path` å·²ä½œä¸º `headingsMap` çš„ keyï¼Œæ— éœ€é‡å¤å­˜å‚¨

---



## ä¸‰ã€åŠŸèƒ½å®ç°ä¸é‡æ„è¯¦è§£

æœ¬ç« èŠ‚æ•´åˆäº†åŸæœ‰çš„â€œéœ€è¦ä¿®æ”¹çš„æ–¹æ³•â€å’Œâ€œåŠŸèƒ½éœ€æ±‚ä¸å‡½æ•°è°ƒç”¨é“¾è·¯â€ï¼Œä»¥åŠŸèƒ½ä¸ºè§†è§’ï¼Œè¯¦è¿°é‡æ„æ–¹æ¡ˆã€‚

### åŠŸèƒ½1ï¼šæ–‡æ¡£åŠ è½½æ—¶åˆå§‹åŒ–æ€ç»´å¯¼å›¾

**ç”¨æˆ·åœºæ™¯**ï¼šæ‰“å¼€åŒ…å«æ ‡é¢˜çš„ Markdown æ–‡æ¡£ã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

1.  **`_update()` - ä¸»æ›´æ–°æµç¨‹**
    *   **è°ƒç”¨ `_getDocumentHeadings()`**ï¼šæå–æ–‡æ¡£æ‰€æœ‰æ ‡é¢˜ï¼Œæ„å»º `HeadingInfo` å¯¹è±¡ã€‚æ­¤æ—¶ï¼Œåœ¨ `headingsMap` ä¸­ä½¿ç”¨ä¸´æ—¶ keyï¼ˆå¦‚ `temp-0`, `temp-1`...ï¼‰è¿›è¡Œå­˜å‚¨ã€‚
    *   **è°ƒç”¨ `transformer.transform(markdown)`**ï¼šå°† Markdown æ–‡æœ¬è½¬æ¢ä¸º `IPureNode` æ ‘å½¢æ•°æ®ã€‚
    *   **åˆ é™¤ `_addNodePath()` è°ƒç”¨**ï¼šåºŸå¼ƒæ‰‹åŠ¨æ„å»ºè·¯å¾„çš„é€»è¾‘ã€‚
    *   **è°ƒç”¨ `markmap.setData(root)`**ï¼šæ¸²æŸ“æ€ç»´å¯¼å›¾ã€‚`markmap-view` åœ¨æ­¤æ­¥éª¤ä¸­ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”ŸæˆåŒ…å« `state.path` çš„ `INode`ã€‚
    *   **è°ƒç”¨ `_syncHeadingsWithNodes(root)`**ï¼š
        *   **é‡æ„æ­¤æ–¹æ³•**ï¼šéå† `INode` æ ‘ï¼Œè·å– markmap ç”Ÿæˆçš„ `state.path`ã€‚
        *   å°† `headingsMap` ä¸­çš„ä¸´æ—¶ key æ›¿æ¢ä¸ºçœŸå®çš„ `state.path`ã€‚
        *   **æ–°å¢**ï¼šå¡«å…… `elementToPathMap` æ˜ å°„ï¼ˆ`HTMLElement` -> `state.path`ï¼‰ã€‚
    *   **è°ƒç”¨ `_attachNodeClickListeners()`**ï¼šä¸ºæ¸²æŸ“å¥½çš„ SVG èŠ‚ç‚¹ç»‘å®šç‚¹å‡»äº‹ä»¶ã€‚

### åŠŸèƒ½2ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾èŠ‚ç‚¹è·³è½¬åˆ°æ–‡æ¡£æ ‡é¢˜

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„æŸä¸ªèŠ‚ç‚¹ã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

1.  **`_attachNodeClickListeners()` - æ•è·ç‚¹å‡»äº‹ä»¶**
2.  **`_scrollToHeadingByNode(nodeEl)` - å¤„ç†èŠ‚ç‚¹è·³è½¬**
    *   **ç®€åŒ–æ­¤æ–¹æ³•**ï¼šä» `nodeEl.__data__` ä¸­ç›´æ¥è·å– `state.path`ã€‚
    *   ä½¿ç”¨ `state.path` ä½œä¸º keyï¼Œåœ¨ `headingsMap` ä¸­æŸ¥æ‰¾å¯¹åº”çš„ `HeadingInfo`ã€‚
3.  **`_scrollToElement(heading.element)` - æ»šåŠ¨åˆ°æ ‡é¢˜ä½ç½®**

**æ•°æ®æµ**: `SVG èŠ‚ç‚¹` â†’ `state.path` â†’ `headingsMap` â†’ `HTMLElement` â†’ æ»šåŠ¨å®šä½ã€‚

### åŠŸèƒ½3ï¼šæ–‡æ¡£æ»šåŠ¨æ—¶é«˜äº®å½“å‰æ ‡é¢˜å¯¹åº”çš„æ€ç»´å¯¼å›¾èŠ‚ç‚¹

**ç”¨æˆ·åœºæ™¯**ï¼šåœ¨æ–‡æ¡£ä¸­æ»šåŠ¨æµè§ˆã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

1.  **`_onScroll()` - æ»šåŠ¨äº‹ä»¶å¤„ç†ï¼ˆé˜²æŠ–ï¼‰**
2.  **`_getCurrentVisibleHeading()` - æŸ¥æ‰¾å½“å‰å¯è§æ ‡é¢˜**
    *   **é‡æ„æ­¤æ–¹æ³•**ï¼šä»…éœ€è¿”å›ç¬¬ä¸€ä¸ªå¯è§çš„æ ‡é¢˜ `HTMLElement`ã€‚
3.  **`elementToPathMap.get(headingElement)` - è·å–æ ‡é¢˜çš„ `state.path`**
    *   åˆ©ç”¨æ–°å»ºçš„ `elementToPathMap` å®ç° O(1) å¤æ‚åº¦çš„å¿«é€ŸæŸ¥æ‰¾ã€‚
4.  **`_findDOMNodeByStatePath(path)` - æŸ¥æ‰¾å¯¹åº”çš„ SVG èŠ‚ç‚¹**
    *   **é‡æ„/é‡å‘½å**ï¼šåŸ `_findNodeByPath` é‡å‘½åä¸ºæ­¤ï¼Œé€šè¿‡ `querySelector(\"[data-path=\"${path}\"]\")` æŸ¥æ‰¾ã€‚
5.  **`_highlightNode(nodeEl)` - é«˜äº®èŠ‚ç‚¹**

**æ•°æ®æµ**: `HTMLElement` â†’ `elementToPathMap` â†’ `state.path` â†’ `SVG DOM èŠ‚ç‚¹` â†’ é«˜äº®æ ·å¼ã€‚

### åŠŸèƒ½4ï¼šè‡ªåŠ¨é€‚åº”è§†å›¾ï¼ˆèšç„¦å½“å‰æ ‡é¢˜ï¼‰

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»"é€‚åº”è§†å›¾"æŒ‰é’®æˆ–æ»šåŠ¨åˆ°æ–°æ ‡é¢˜ã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

1.  **`_fitToView()` - é€‚åº”è§†å›¾ä¸»æµç¨‹**
    *   **é‡æ„æ­¤æ–¹æ³•**ï¼šè·å–å½“å‰æ ‡é¢˜çš„ `HTMLElement`ã€‚
2.  **`_findNodeByHeading(headingElement)` - æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹**
    *   **æ–°å¢æ­¤æ–¹æ³•**ï¼šé€šè¿‡ `elementToPathMap` è·å– `state.path`ï¼Œå†è°ƒç”¨ `_findNodeByStatePath()` åœ¨æ•°æ®æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„ `INode` å¯¹è±¡ã€‚
3.  **`_ensureNodeVisible(targetNode)` - ç¡®ä¿èŠ‚ç‚¹å¯è§**
    *   **é‡æ„æ­¤æ–¹æ³•**ï¼šè¿™æ˜¯æœ¬æ¬¡é‡æ„çš„å…³é”®ã€‚æ¥æ”¶ `targetNode` ä½œä¸ºå‚æ•°ã€‚
    *   **è°ƒç”¨ `_getAncestorPaths(targetNode.state.path)`**ï¼š
        *   **æ–°å¢æ­¤æ–¹æ³•**ï¼šæ ¹æ® `"0.1.3"` è®¡ç®—å‡ºæ‰€æœ‰ç¥–å…ˆè·¯å¾„ `["0", "0.1"]`ã€‚
    *   éå†ç¥–å…ˆè·¯å¾„ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç¥–å…ˆ `INode`ã€‚
    *   æ£€æŸ¥ç¥–å…ˆèŠ‚ç‚¹çš„ `state.fold` çŠ¶æ€ï¼Œå¦‚æœä¸º `1` (æŠ˜å )ï¼Œåˆ™è°ƒç”¨ `await markmap.toggleNode(ancestorNode)` å°†å…¶å±•å¼€ã€‚
4.  **`_panAndZoomToNode(targetNode)` - å¹³ç§»å’Œç¼©æ”¾åˆ°ç›®æ ‡èŠ‚ç‚¹**

**æ•°æ®æµ**: `HTMLElement` â†’ `elementToPathMap` â†’ `state.path` â†’ `INode` â†’ ç¥–å…ˆå±•å¼€ â†’ è§†å›¾èšç„¦ã€‚

### åŠŸèƒ½5ï¼šæ–‡æ¡£å†…å®¹å®æ—¶æ›´æ–°

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·ç¼–è¾‘æ–‡æ¡£ï¼Œæ·»åŠ /åˆ é™¤/ä¿®æ”¹æ ‡é¢˜ã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

1.  **`MutationObserver` è§¦å‘ `_onContentChange()`**
2.  **`_getDocumentHeadings()` - é‡æ–°æå–æ ‡é¢˜**
3.  **`_getHeadingsHash()` - è®¡ç®—æ ‡é¢˜å“ˆå¸Œ**
    *   **ç®€åŒ–æ­¤æ–¹æ³•**ï¼šä½¿ç”¨æ ‡é¢˜çš„ `level + text + index` ç”Ÿæˆå“ˆå¸Œï¼Œä¸å†ä¾èµ– `path`ã€‚
4.  **`transformer.transform()` -> `_syncHeadingsWithNodes()` -> `markmap.setData()`**
    *   è°ƒç”¨ `setData()` æ›´æ–°æ€ç»´å¯¼å›¾ï¼ŒMarkmap ä¼šè‡ªåŠ¨ä¿æŒå¤§éƒ¨åˆ†èŠ‚ç‚¹çš„æŠ˜å çŠ¶æ€å’Œè§†å›¾ä½ç½®ã€‚

### åŠŸèƒ½6ï¼šèŠ‚ç‚¹æŠ˜å /å±•å¼€

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾èŠ‚ç‚¹çš„æŠ˜å æŒ‰é’®ã€‚

**éœ€æ±‚é“¾è·¯ä¸é‡æ„æ–¹æ¡ˆ**ï¼š

*   æ­¤åŠŸèƒ½ä¸»è¦ç”± Markmap å†…éƒ¨è‡ªåŠ¨å¤„ç†ã€‚
*   æˆ‘ä»¬çš„ `_ensureNodeVisible()` æ–¹æ³•å°†é€šè¿‡è°ƒç”¨ `markmap.toggleNode()` æ¥åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œä»¥ç¡®ä¿åœ¨èšç„¦èŠ‚ç‚¹å‰ï¼Œå…¶æ‰€æœ‰ç¥–å…ˆéƒ½å¤„äºå±•å¼€çŠ¶æ€ã€‚







## å…«ã€ç±»å‹ä½¿ç”¨è§„èŒƒ

### å¯¼å…¥ç±»å‹
```typescript
import { INode } from 'markmap-common';
```

### æ–¹æ³•ç­¾åä¸­ä½¿ç”¨ INode
æ‰€æœ‰å¤„ç† markmap èŠ‚ç‚¹çš„æ–¹æ³•åº”ä½¿ç”¨ `INode` ç±»å‹ï¼Œè€Œä¸æ˜¯ `any`ï¼š

```typescript
// âœ… æ­£ç¡®
private _syncHeadingsWithNodes(node: INode, index = { current: 0 }): void

// âŒ é”™è¯¯
private _syncHeadingsWithNodes(node: any, index = { current: 0 }): void
```

**éœ€è¦ä¿®æ”¹ç±»å‹çš„æ–¹æ³•ï¼š**
- `_syncHeadingsWithNodes(node: INode, ...)`
- `_ensureNodeVisible(targetNode: INode): Promise<void>`
- `_findNodeByStatePath(targetPath: string): INode | null`
- `_findNodeByHeading(headingElement: HTMLElement): INode | null`

---

## ä¹ã€å®Œæ•´ä¿®æ”¹æ¸…å•

### âŒ å¿…é¡»åˆ é™¤
1. `_addNodePath` (ç¬¬885è¡Œ) - åˆ é™¤æ•´ä¸ªæ–¹æ³•

### ğŸ”§ å¿…é¡»ä¿®æ”¹ï¼ˆç±»å‹/çŠ¶æ€ï¼‰
2. `HeadingInfo` - åˆ é™¤ `path` å­—æ®µ
3. `state` - æ·»åŠ  `elementToPath: Map<HTMLElement, string>`
4. æ–‡ä»¶é¡¶éƒ¨ - æ·»åŠ  `import { INode } from 'markmap-common'`

### ğŸ”„ å¿…é¡»ä¿®æ”¹ï¼ˆæ–¹æ³•ï¼‰
5. `_update` - åˆ é™¤ `this._addNodePath(root)` è°ƒç”¨
6. `_getDocumentHeadings` - åˆ é™¤ `path` å­—æ®µåˆå§‹åŒ–
7. `_syncHeadingsWithNodes` - ä½¿ç”¨ `node.state.path`ï¼Œæ›´æ–° `elementToPath`ï¼Œå‚æ•°æ”¹ä¸º `INode`
8. `_scrollToHeadingByNode` - ä½¿ç”¨ `nodeData.state.path`
9. `_getHeadingsHash` - ä½¿ç”¨ `index` ä»£æ›¿ `path`

### ğŸ”¨ å¿…é¡»é‡æ„
10. `_getCurrentVisibleHeading` - ä½¿ç”¨ `elementToPath` è·å– `state.path`
11. `_ensureNodeVisible` - é€šè¿‡ `state.path` è®¡ç®—ç¥–å…ˆï¼Œå‚æ•°æ”¹ä¸º `INode`ï¼Œè¿”å› `Promise<void>`
12. `_fitToView` - é€‚é…æ–°çš„æ–¹æ³•åå’Œé€»è¾‘

### ğŸ·ï¸ å¿…é¡»é‡å‘½å
13. `_findNodeByPath` â†’ `_findDOMNodeByStatePath`
14. `_findDataNodeByPath` â†’ `_findNodeByStatePath`ï¼Œè¿”å›ç±»å‹æ”¹ä¸º `INode | null`

### â• å¿…é¡»æ–°å¢
15. `_getAncestorPaths(path: string): string[]`
16. `_findNodeByHeading(element: HTMLElement): INode | null`

**æ€»è®¡**: 16å¤„ä¿®æ”¹











## åä¸€ã€åŠŸèƒ½éœ€æ±‚ä¸å‡½æ•°è°ƒç”¨é“¾è·¯

### åŠŸèƒ½1ï¼šæ–‡æ¡£åŠ è½½æ—¶åˆå§‹åŒ–æ€ç»´å¯¼å›¾

**ç”¨æˆ·åœºæ™¯**ï¼šæ‰“å¼€åŒ…å«æ ‡é¢˜çš„ Markdown æ–‡æ¡£

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·æ‰“å¼€æ–‡æ¡£
  â†“
_update() - ä¸»æ›´æ–°æµç¨‹
  â†“
_getDocumentHeadings() - æå–æ–‡æ¡£æ‰€æœ‰æ ‡é¢˜
  â”‚ â””â†’ éå† h1-h6 å…ƒç´ ï¼Œæ„å»º HeadingInfo å¯¹è±¡
  â”‚ â””â†’ ä½¿ç”¨ä¸´æ—¶ keyï¼ˆtemp-0, temp-1...ï¼‰å­˜å…¥ headingsMap
  â†“
transformer.transform(markdown) - å°† Markdown è½¬ä¸ºæ ‘å½¢æ•°æ®
  â”‚ â””â†’ markmap-lib è§£ææ ‡é¢˜å±‚çº§ï¼Œç”Ÿæˆ INode æ ‘
  â†“
_syncHeadingsWithNodes(root) - åŒæ­¥æ ‡é¢˜ä¸èŠ‚ç‚¹æ˜ å°„
  â”‚ â””â†’ éå† INode æ ‘ï¼Œè·å– markmap ç”Ÿæˆçš„ state.path
  â”‚ â””â†’ å°†ä¸´æ—¶ key æ›¿æ¢ä¸º state.path
  â”‚ â””â†’ æ›´æ–° elementToPath æ˜ å°„ï¼ˆelement â†’ state.pathï¼‰
  â†“
markmap.setData(root) - æ¸²æŸ“æ€ç»´å¯¼å›¾
  â”‚ â””â†’ markmap-view è‡ªåŠ¨ç”Ÿæˆ state.id å’Œ state.path
  â”‚ â””â†’ ç»˜åˆ¶ SVG èŠ‚ç‚¹ï¼Œæ·»åŠ  data-path å±æ€§
  â†“
_attachNodeClickListeners() - ç»‘å®šèŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
  â””â†’ ç›‘å¬ SVG èŠ‚ç‚¹ç‚¹å‡»ï¼Œè§¦å‘è·³è½¬åŠŸèƒ½
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `_getDocumentHeadings()`ï¼šæå–æ–‡æ¡£æ ‡é¢˜ï¼Œå»ºç«‹åˆå§‹æ˜ å°„ï¼ˆä¸´æ—¶ keyï¼‰
- `_syncHeadingsWithNodes()`ï¼šå°†ä¸´æ—¶ key æ›¿æ¢ä¸º markmap çš„ state.path
- `_attachNodeClickListeners()`ï¼šä¸ºæ€ç»´å¯¼å›¾èŠ‚ç‚¹ç»‘å®šäº¤äº’äº‹ä»¶

---

### åŠŸèƒ½2ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾èŠ‚ç‚¹è·³è½¬åˆ°æ–‡æ¡£æ ‡é¢˜

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„æŸä¸ªèŠ‚ç‚¹

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·ç‚¹å‡»æ€ç»´å¯¼å›¾èŠ‚ç‚¹
  â†“
_attachNodeClickListeners() - æ•è·ç‚¹å‡»äº‹ä»¶
  â†“
_scrollToHeadingByNode(nodeEl) - å¤„ç†èŠ‚ç‚¹è·³è½¬
  â”‚ â””â†’ ä» nodeEl.__data__ è·å– state.path
  â”‚ â””â†’ é€šè¿‡ headingsMap.get(state.path) æŸ¥æ‰¾å¯¹åº”æ ‡é¢˜
  â†“
_scrollToElement(heading.element) - æ»šåŠ¨åˆ°æ ‡é¢˜ä½ç½®
  â””â†’ ä½¿ç”¨ scrollIntoView æˆ– Typora API å®šä½
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `_scrollToHeadingByNode()`ï¼šæ ¹æ® state.path æŸ¥æ‰¾æ ‡é¢˜å¹¶è·³è½¬
- `_scrollToElement()`ï¼šæ‰§è¡Œå®é™…çš„æ»šåŠ¨æ“ä½œ

**æ•°æ®æµ**ï¼š
```
SVG èŠ‚ç‚¹ â†’ state.path â†’ headingsMap â†’ HTMLElement â†’ æ»šåŠ¨å®šä½
```

---

### åŠŸèƒ½3ï¼šæ–‡æ¡£æ»šåŠ¨æ—¶é«˜äº®å½“å‰æ ‡é¢˜å¯¹åº”çš„æ€ç»´å¯¼å›¾èŠ‚ç‚¹

**ç”¨æˆ·åœºæ™¯**ï¼šåœ¨æ–‡æ¡£ä¸­æ»šåŠ¨æµè§ˆ

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·æ»šåŠ¨æ–‡æ¡£
  â†“
_onScroll() - æ»šåŠ¨äº‹ä»¶å¤„ç†ï¼ˆé˜²æŠ–ï¼‰
  â†“
_getCurrentVisibleHeading() - æŸ¥æ‰¾å½“å‰å¯è§æ ‡é¢˜
  â”‚ â””â†’ éå†æ‰€æœ‰æ ‡é¢˜å…ƒç´ ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨è§†å£å†…
  â”‚ â””â†’ è¿”å›ç¬¬ä¸€ä¸ªå¯è§çš„æ ‡é¢˜å…ƒç´ 
  â†“
elementToPath.get(headingElement) - è·å–æ ‡é¢˜çš„ state.path
  â†“
_findDOMNodeByStatePath(path) - æŸ¥æ‰¾å¯¹åº”çš„ SVG èŠ‚ç‚¹
  â”‚ â””â†’ é€šè¿‡ querySelector(`[data-path="${path}"]`) æŸ¥æ‰¾
  â†“
_highlightNode(nodeEl) - é«˜äº®èŠ‚ç‚¹
  â””â†’ æ·»åŠ  CSS ç±»æˆ–ä¿®æ”¹æ ·å¼
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `_getCurrentVisibleHeading()`ï¼šæ£€æµ‹å½“å‰å¯è§çš„æ–‡æ¡£æ ‡é¢˜
- `_findDOMNodeByStatePath()`ï¼šé€šè¿‡ state.path æŸ¥æ‰¾ SVG DOM èŠ‚ç‚¹
- `_highlightNode()`ï¼šè§†è§‰ä¸Šé«˜äº®å½“å‰èŠ‚ç‚¹

**æ•°æ®æµ**ï¼š
```
HTMLElement â†’ elementToPath â†’ state.path â†’ SVG DOM èŠ‚ç‚¹ â†’ é«˜äº®æ ·å¼
```

---

### åŠŸèƒ½4ï¼šè‡ªåŠ¨é€‚åº”è§†å›¾ï¼ˆèšç„¦å½“å‰æ ‡é¢˜ï¼‰

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»"é€‚åº”è§†å›¾"æŒ‰é’®æˆ–æ»šåŠ¨åˆ°æ–°æ ‡é¢˜

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·è§¦å‘é€‚åº”è§†å›¾
  â†“
_fitToView() - é€‚åº”è§†å›¾ä¸»æµç¨‹
  â†“
_getCurrentVisibleHeading() - è·å–å½“å‰æ ‡é¢˜
  â†“
_findNodeByHeading(headingElement) - æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹
  â”‚ â””â†’ é€šè¿‡ elementToPath è·å– state.path
  â”‚ â””â†’ è°ƒç”¨ _findNodeByStatePath() åœ¨æ•°æ®æ ‘ä¸­æŸ¥æ‰¾
  â†“
_ensureNodeVisible(targetNode) - ç¡®ä¿èŠ‚ç‚¹å¯è§
  â”‚ â””â†’ _getAncestorPaths(targetNode.state.path) - è®¡ç®—ç¥–å…ˆè·¯å¾„
  â”‚     â””â†’ ä¾‹å¦‚ "0.1.3" â†’ ["0", "0.1"]
  â”‚ â””â†’ éå†ç¥–å…ˆè·¯å¾„ï¼Œæ£€æŸ¥æŠ˜å çŠ¶æ€
  â”‚ â””â†’ å¦‚æœç¥–å…ˆè¢«æŠ˜å ï¼Œè°ƒç”¨ markmap.toggleNode() å±•å¼€
  â”‚ â””â†’ ç­‰å¾… DOM æ›´æ–°ï¼ˆrequestAnimationFrameï¼‰
  â†“
_panAndZoomToNode(targetNode) - å¹³ç§»å’Œç¼©æ”¾åˆ°ç›®æ ‡èŠ‚ç‚¹
  â”‚ â””â†’ _calculateOptimalScale() - è®¡ç®—æœ€ä½³ç¼©æ”¾æ¯”ä¾‹
  â”‚ â””â†’ åº”ç”¨ SVG transform åŠ¨ç”»
  â””â†’ å®Œæˆèšç„¦
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `_fitToView()`ï¼šåè°ƒæ•´ä¸ªé€‚åº”è§†å›¾æµç¨‹
- `_findNodeByHeading()`ï¼šä»æ ‡é¢˜å…ƒç´ æ‰¾åˆ°æ•°æ®èŠ‚ç‚¹ï¼ˆINodeï¼‰
- `_ensureNodeVisible()`ï¼šå±•å¼€æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œç¡®ä¿ç›®æ ‡å¯è§
- `_getAncestorPaths()`ï¼šä» state.path è®¡ç®—ç¥–å…ˆè·¯å¾„åˆ—è¡¨
- `_findNodeByStatePath()`ï¼šåœ¨æ•°æ®æ ‘ä¸­é€šè¿‡ state.path æŸ¥æ‰¾èŠ‚ç‚¹
- `_panAndZoomToNode()`ï¼šæ‰§è¡Œå¹³æ»‘çš„è§†å›¾åŠ¨ç”»

**æ•°æ®æµ**ï¼š
```
HTMLElement â†’ elementToPath â†’ state.path â†’ INode â†’ ç¥–å…ˆå±•å¼€ â†’ è§†å›¾èšç„¦
```

---

### åŠŸèƒ½5ï¼šæ–‡æ¡£å†…å®¹å®æ—¶æ›´æ–°

**ç”¨æˆ·åœºæ™¯**ï¼šç”¨æˆ·ç¼–è¾‘æ–‡æ¡£ï¼Œæ·»åŠ /åˆ é™¤/ä¿®æ”¹æ ‡é¢˜

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£
  â†“
MutationObserver è§¦å‘
  â†“
_onContentChange() - å†…å®¹å˜åŒ–å¤„ç†ï¼ˆé˜²æŠ–ï¼‰
  â†“
_getDocumentHeadings() - é‡æ–°æå–æ ‡é¢˜
  â”‚ â””â†’ ç”Ÿæˆæ–°çš„ headingsMapï¼ˆä¸´æ—¶ keyï¼‰
  â†“
_getHeadingsHash() - è®¡ç®—æ ‡é¢˜å“ˆå¸Œ
  â”‚ â””â†’ ä½¿ç”¨æ ‡é¢˜çš„ level + text + index ç”Ÿæˆå“ˆå¸Œ
  â”‚ â””â†’ ä¸ä¸Šæ¬¡å“ˆå¸Œå¯¹æ¯”ï¼Œåˆ¤æ–­æ˜¯å¦çœŸçš„å˜åŒ–
  â†“
å¦‚æœå“ˆå¸Œä¸åŒï¼š
  â†“
  transformer.transform(markdown) - é‡æ–°è§£æ
  â†“
  _syncHeadingsWithNodes(root) - é‡æ–°åŒæ­¥æ˜ å°„
  â†“
  markmap.setData(root) - æ›´æ–°æ€ç»´å¯¼å›¾
    â””â†’ markmap ä¿æŒç°æœ‰çš„æŠ˜å çŠ¶æ€å’Œè§†å›¾ä½ç½®
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `_onContentChange()`ï¼šç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œè§¦å‘æ›´æ–°
- `_getHeadingsHash()`ï¼šé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- `markmap.setData()`ï¼šå¢é‡æ›´æ–°ï¼Œä¿æŒç”¨æˆ·çŠ¶æ€

**ä¼˜åŒ–ç‚¹**ï¼š
- ä½¿ç”¨å“ˆå¸Œå¯¹æ¯”é¿å…é¢‘ç¹é‡ç»˜
- `setData()` ä¿æŒæŠ˜å çŠ¶æ€ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½

---

### åŠŸèƒ½6ï¼šèŠ‚ç‚¹æŠ˜å /å±•å¼€

**ç”¨æˆ·åœºæ™¯**ï¼šç‚¹å‡»æ€ç»´å¯¼å›¾èŠ‚ç‚¹çš„æŠ˜å æŒ‰é’®

**éœ€æ±‚é“¾è·¯**ï¼š
```
ç”¨æˆ·ç‚¹å‡»æŠ˜å æŒ‰é’®
  â†“
markmap å†…éƒ¨å¤„ç†ï¼ˆè‡ªåŠ¨ï¼‰
  â”‚ â””â†’ æ›´æ–° node.payload.fold çŠ¶æ€
  â”‚ â””â†’ é‡æ–°æ¸²æŸ“å­èŠ‚ç‚¹
  â†“
ï¼ˆå¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶ï¼‰
  â†“
markmap.toggleNode(node) - åˆ‡æ¢æŠ˜å çŠ¶æ€
  â””â†’ markmap è‡ªåŠ¨æ›´æ–° DOM
```

**å…³é”®å‡½æ•°èŒè´£**ï¼š
- `markmap.toggleNode()`ï¼šåˆ‡æ¢èŠ‚ç‚¹æŠ˜å çŠ¶æ€ï¼ˆmarkmap-view æä¾›ï¼‰
- `_ensureNodeVisible()` ä¸­ä½¿ç”¨ï¼šå±•å¼€è¢«æŠ˜å çš„ç¥–å…ˆèŠ‚ç‚¹

**æ³¨æ„**ï¼š
- æŠ˜å çŠ¶æ€ç”± markmap è‡ªåŠ¨ç®¡ç†ï¼Œå­˜å‚¨åœ¨ `node.payload.fold`
- ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ DOMï¼Œè°ƒç”¨ API å³å¯

---

## åäºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ–‡æ¡£æ ‡é¢˜å±‚                              â”‚
â”‚  <h1>ç¬¬ä¸€ç« </h1>  <h2>ç¬¬ä¸€èŠ‚</h2>  <h3>ç¬¬ä¸€å°èŠ‚</h3>           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ _getDocumentHeadings()
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    headingsMap (Map)                         â”‚
â”‚  key: state.path (å¦‚ "0.1.3")                                â”‚
â”‚  value: HeadingInfo {                                        â”‚
â”‚    level: 3,                                                 â”‚
â”‚    text: "ç¬¬ä¸€å°èŠ‚",                                          â”‚
â”‚    element: HTMLElement,                                     â”‚
â”‚    id: "heading-3",                                          â”‚
â”‚    index: 2                                                  â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 elementToPath (Map)                          â”‚
â”‚  key: HTMLElement (æ ‡é¢˜å…ƒç´ )                                  â”‚
â”‚  value: state.path (å¦‚ "0.1.3")                              â”‚
â”‚  ç”¨é€”ï¼šä»æ ‡é¢˜å…ƒç´ å¿«é€ŸæŸ¥æ‰¾ state.path                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INode æ•°æ®æ ‘                               â”‚
â”‚  {                                                           â”‚
â”‚    content: "<h3>ç¬¬ä¸€å°èŠ‚</h3>",                              â”‚
â”‚    state: {                                                  â”‚
â”‚      id: 3,                                                  â”‚
â”‚      path: "0.1.3",  â† markmap è‡ªåŠ¨ç”Ÿæˆ                      â”‚
â”‚      depth: 2                                                â”‚
â”‚    },                                                        â”‚
â”‚    payload: { fold: 0 },                                    â”‚
â”‚    children: [...]                                           â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ markmap.setData()
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SVG DOM èŠ‚ç‚¹                               â”‚
â”‚  <g data-path="0.1.3" class="markmap-node">                 â”‚
â”‚    <circle />                                                â”‚
â”‚    <text>ç¬¬ä¸€å°èŠ‚</text>                                      â”‚
â”‚  </g>                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµå‘**ï¼š
1. **åˆå§‹åŒ–**ï¼šHTML æ ‡é¢˜ â†’ headingsMap + elementToPath â†’ INode æ ‘ â†’ SVG
2. **ç‚¹å‡»è·³è½¬**ï¼šSVG èŠ‚ç‚¹ â†’ state.path â†’ headingsMap â†’ HTML æ ‡é¢˜
3. **æ»šåŠ¨é«˜äº®**ï¼šHTML æ ‡é¢˜ â†’ elementToPath â†’ state.path â†’ SVG èŠ‚ç‚¹
4. **é€‚åº”è§†å›¾**ï¼šHTML æ ‡é¢˜ â†’ elementToPath â†’ state.path â†’ INode â†’ å±•å¼€ç¥–å…ˆ â†’ èšç„¦

---

## åä¸‰ã€é‡æ„å‰åå¯¹æ¯”

### å¯¹æ¯”1ï¼šèŠ‚ç‚¹æ ‡è¯†æ–¹å¼

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| æ ‡è¯†ç¬¦ | è‡ªå®šä¹‰æ–‡æœ¬è·¯å¾„ï¼ˆ"ç¬¬ä¸€ç« \nç¬¬ä¸€èŠ‚"ï¼‰ | markmap çš„ state.pathï¼ˆ"0.1.3"ï¼‰ |
| ç”Ÿæˆæ–¹å¼ | æ‰‹åŠ¨æ‹¼æ¥æ ‡é¢˜æ–‡æœ¬ | markmap-view è‡ªåŠ¨ç”Ÿæˆ |
| å”¯ä¸€æ€§ | æ ‡é¢˜é‡åæ—¶ä¼šå†²çª | åŸºäºèŠ‚ç‚¹ IDï¼Œç»å¯¹å”¯ä¸€ |
| ç»´æŠ¤æˆæœ¬ | éœ€è¦æ‰‹åŠ¨ç»´æŠ¤è·¯å¾„é€»è¾‘ | é›¶ç»´æŠ¤ï¼Œç”± markmap ç®¡ç† |

### å¯¹æ¯”2ï¼šæŸ¥æ‰¾èŠ‚ç‚¹æ•ˆç‡

| æ“ä½œ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| æŸ¥æ‰¾æ•°æ®èŠ‚ç‚¹ | éå†æ ‘ï¼Œé€å±‚åŒ¹é…æ–‡æœ¬ | é€šè¿‡ state.path ç›´æ¥å®šä½ |
| æŸ¥æ‰¾ DOM èŠ‚ç‚¹ | éå† SVGï¼ŒåŒ¹é…è‡ªå®šä¹‰å±æ€§ | querySelector(`[data-path="${path}"]`) |
| æ—¶é—´å¤æ‚åº¦ | O(n) | O(1) æˆ– O(log n) |

### å¯¹æ¯”3ï¼šä»£ç è¡Œæ•°

| æ¨¡å— | é‡æ„å‰ | é‡æ„å | å‡å°‘ |
|------|--------|--------|------|
| `_addNodePath` | ~30 è¡Œ | åˆ é™¤ | -30 |
| `_syncHeadingsWithNodes` | ~25 è¡Œ | ~15 è¡Œ | -10 |
| `_ensureNodeVisible` | ~40 è¡Œ | ~25 è¡Œ | -15 |
| æ–°å¢è¾…åŠ©æ–¹æ³• | 0 | ~15 è¡Œ | +15 |
| **æ€»è®¡** | ~95 è¡Œ | ~55 è¡Œ | **-40 è¡Œ** |

---

## åå››ã€å…³é”®æŠ€æœ¯å†³ç­–

### å†³ç­–1ï¼šä¸ºä»€ä¹ˆä½¿ç”¨ state.path è€Œä¸æ˜¯è‡ªå®šä¹‰è·¯å¾„ï¼Ÿ

**ç†ç”±**ï¼š
1. **å®˜æ–¹æ”¯æŒ**ï¼šstate.path æ˜¯ markmap-view çš„æ ‡å‡†å­—æ®µï¼Œæœ‰ç¨³å®šçš„ç”Ÿæˆé€»è¾‘
2. **å”¯ä¸€æ€§ä¿è¯**ï¼šåŸºäºè‡ªå¢ IDï¼Œä¸ä¼šå› æ ‡é¢˜é‡åè€Œå†²çª
3. **DOM åŒæ­¥**ï¼šmarkmap è‡ªåŠ¨å°† state.path å†™å…¥ `data-path` å±æ€§ï¼Œä¾¿äºæŸ¥è¯¢
4. **é›¶ç»´æŠ¤æˆæœ¬**ï¼šä¸éœ€è¦æ‰‹åŠ¨æ„å»ºå’Œæ›´æ–°è·¯å¾„

### å†³ç­–2ï¼šä¸ºä»€ä¹ˆéœ€è¦ elementToPath æ˜ å°„ï¼Ÿ

**ç†ç”±**ï¼š
1. **åŒå‘æŸ¥æ‰¾**ï¼š
  - ä»æ ‡é¢˜åˆ°èŠ‚ç‚¹ï¼š`elementToPath.get(element)` â†’ state.path â†’ INode
  - ä»èŠ‚ç‚¹åˆ°æ ‡é¢˜ï¼šstate.path â†’ `headingsMap.get(path)` â†’ element
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…æ¯æ¬¡éƒ½éå† headingsMap æŸ¥æ‰¾å…ƒç´ 
3. **ä»£ç æ¸…æ™°**ï¼šæ˜ç¡®è¡¨è¾¾"å…ƒç´ åˆ°è·¯å¾„"çš„æ˜ å°„å…³ç³»

### å†³ç­–3ï¼šä¸ºä»€ä¹ˆ _ensureNodeVisible è¿”å› Promiseï¼Ÿ

**ç†ç”±**ï¼š
1. **å¼‚æ­¥å±•å¼€**ï¼šè°ƒç”¨ `markmap.toggleNode()` åï¼ŒDOM æ›´æ–°æ˜¯å¼‚æ­¥çš„
2. **é“¾å¼æ“ä½œ**ï¼šå±•å¼€èŠ‚ç‚¹åéœ€è¦ç­‰å¾… DOM æ›´æ–°ï¼Œæ‰èƒ½æ‰§è¡Œåç»­çš„èšç„¦æ“ä½œ
3. **é¿å…ç«æ€**ï¼šä½¿ç”¨ `await` ç¡®ä¿æ“ä½œé¡ºåºæ­£ç¡®

```typescript
// æ­£ç¡®çš„è°ƒç”¨æ–¹å¼
await this._ensureNodeVisible(targetNode);
this._panAndZoomToNode(targetNode);  // æ­¤æ—¶èŠ‚ç‚¹å·²å±•å¼€
```



---

## åå…­ã€è¿ç§»æ£€æŸ¥æ¸…å•

### ä»£ç ä¿®æ”¹
- [ ] åˆ é™¤ `_addNodePath` æ–¹æ³•
- [ ] ä¿®æ”¹ `HeadingInfo` ç±»å‹å®šä¹‰
- [ ] æ·»åŠ  `elementToPath: Map<HTMLElement, string>` åˆ° state
- [ ] å¯¼å…¥ `INode` ç±»å‹
- [ ] ä¿®æ”¹ `_syncHeadingsWithNodes` ä½¿ç”¨ state.path
- [ ] ä¿®æ”¹ `_scrollToHeadingByNode` ä½¿ç”¨ state.path
- [ ] é‡æ„ `_ensureNodeVisible` ä½¿ç”¨ `_getAncestorPaths`
- [ ] é‡å‘½å `_findNodeByPath` â†’ `_findDOMNodeByStatePath`
- [ ] é‡å‘½å `_findDataNodeByPath` â†’ `_findNodeByStatePath`
- [ ] æ–°å¢ `_getAncestorPaths` æ–¹æ³•
- [ ] æ–°å¢ `_findNodeByHeading` æ–¹æ³•
- [ ] æ›´æ–° `_fitToView` é€‚é…æ–°é€»è¾‘

### æµ‹è¯•éªŒè¯
- [ ] ç‚¹å‡»èŠ‚ç‚¹è·³è½¬åŠŸèƒ½æ­£å¸¸
- [ ] æ»šåŠ¨é«˜äº®åŠŸèƒ½æ­£å¸¸
- [ ] é€‚åº”è§†å›¾åŠŸèƒ½æ­£å¸¸
- [ ] å®æ—¶æ›´æ–°åŠŸèƒ½æ­£å¸¸
- [ ] æ ‡é¢˜é‡ååœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] æ·±å±‚åµŒå¥—åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•é€šè¿‡

### æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° API æ–‡æ¡£è¯´æ˜ state.path çš„ä½¿ç”¨
- [ ] æ›´æ–°æ¶æ„å›¾ï¼Œæ ‡æ³¨æ•°æ®æµå‘
- [ ] è®°å½•é‡æ„å†³ç­–å’Œç†ç”±

---

## åä¸ƒã€å¸¸è§é—®é¢˜ FAQ

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ node.state.id ä½œä¸ºæ ‡è¯†ç¬¦ï¼Ÿ

**A**ï¼š`state.id` æ˜¯å…¨å±€è‡ªå¢çš„ï¼Œæ— æ³•è¡¨è¾¾èŠ‚ç‚¹çš„å±‚çº§å…³ç³»ã€‚è€Œ `state.path` åŒ…å«äº†å®Œæ•´çš„ç¥–å…ˆä¿¡æ¯ï¼ˆå¦‚ "0.1.3" è¡¨ç¤ºæ ¹èŠ‚ç‚¹ â†’ ç¬¬1ä¸ªå­èŠ‚ç‚¹ â†’ ç¬¬3ä¸ªå­™å­èŠ‚ç‚¹ï¼‰ï¼Œä¾¿äºè®¡ç®—ç¥–å…ˆè·¯å¾„ã€‚

### Q2ï¼šå¦‚æœç”¨æˆ·ä¿®æ”¹æ ‡é¢˜ï¼Œstate.path ä¼šå˜åŒ–å—ï¼Ÿ

**A**ï¼šä¸ä¼šã€‚`state.path` åŸºäºèŠ‚ç‚¹åœ¨æ ‘ä¸­çš„ä½ç½®ï¼Œåªè¦ä½ç½®ä¸å˜ï¼Œpath å°±ä¸å˜ã€‚ä¿®æ”¹æ ‡é¢˜æ–‡æœ¬åªä¼šæ›´æ–° `node.content`ï¼Œä¸å½±å“ `state.path`ã€‚

### Q3ï¼šå¦‚æœç”¨æˆ·åˆ é™¤ä¸­é—´çš„æ ‡é¢˜ï¼Œå…¶ä»–èŠ‚ç‚¹çš„ state.path ä¼šå˜å—ï¼Ÿ

**A**ï¼šä¼šã€‚å› ä¸º `state.id` æ˜¯æŒ‰éå†é¡ºåºè‡ªå¢çš„ï¼Œåˆ é™¤èŠ‚ç‚¹åï¼Œåç»­èŠ‚ç‚¹çš„ ID ä¼šå‰ç§»ã€‚ä½†è¿™ä¸å½±å“åŠŸèƒ½ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ¯æ¬¡æ›´æ–°æ—¶éƒ½ä¼šé‡æ–°åŒæ­¥ `headingsMap`ã€‚

### Q4ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ node.state.key ä½œä¸ºæ ‡è¯†ç¬¦ï¼Ÿ

**A**ï¼š`state.key` æ˜¯åŸºäºå†…å®¹çš„å“ˆå¸Œï¼Œè™½ç„¶å”¯ä¸€ï¼Œä½†æ— æ³•è¡¨è¾¾å±‚çº§å…³ç³»ï¼Œä¹Ÿä¸æ–¹ä¾¿è®¡ç®—ç¥–å…ˆè·¯å¾„ã€‚è€Œä¸” markmap æ²¡æœ‰å°† `key` å†™å…¥ DOM å±æ€§ï¼Œä¸ä¾¿äºæŸ¥è¯¢ã€‚

### Q5ï¼šé‡æ„åæ€§èƒ½ä¼šæå‡å—ï¼Ÿ

**A**ï¼šä¼šã€‚ä¸»è¦ä½“ç°åœ¨ï¼š
1. æŸ¥æ‰¾èŠ‚ç‚¹ä» O(n) é™åˆ° O(1)
2. ä¸éœ€è¦æ‰‹åŠ¨æ„å»ºè·¯å¾„ï¼Œå‡å°‘è®¡ç®—é‡
3. ä»£ç æ›´ç®€æ´ï¼Œå‡å°‘ bug é£é™©

