# è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
name: Release

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶ï¼ˆå¦‚ v1.0.0ï¼‰
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    # æˆäºˆå†™å…¥ä»“åº“å†…å®¹çš„æƒé™ï¼Œç”¨äºåˆ›å»º release
    permissions:
      contents: write

    steps:
      # æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install

      # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      - name: Build
        run: npm run build:prod

      # ç”Ÿæˆæ›´æ–°è¯´æ˜ï¼ˆä»ä¸Šä¸€ä¸ªç‰ˆæœ¬åˆ°å½“å‰ç‰ˆæœ¬çš„æ‰€æœ‰commitï¼‰
      - name: Generate changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªtag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # ç”Ÿæˆchangelog
          if [ -n "$PREV_TAG" ]; then
            echo "## ğŸš€ æ›´æ–°å†…å®¹" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "**å®Œæ•´æäº¤è®°å½• (${PREV_TAG}...${GITHUB_REF_NAME}):**" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "## ğŸš€ é¦–æ¬¡å‘å¸ƒ" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "**æ‰€æœ‰æäº¤è®°å½•:**" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
          fi

      # åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release package
        run: |
          cd dist
          zip -r ../plugin.zip .
          cd ..
          ls -la *.zip

      # åˆ›å»º GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: plugin.zip
          body_path: CHANGELOG.md
